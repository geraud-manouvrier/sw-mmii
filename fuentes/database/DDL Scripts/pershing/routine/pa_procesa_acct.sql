create or replace procedure pershing.pa_procesa_acct(IN _id_proceso bigint)
    language plpgsql
as
$$
DECLARE _cursor_reg_modif refcursor;
DECLARE _reg_modif record;
DECLARE _process_date VARCHAR(100);
begin

    SELECT tb_proc.process_date INTO _process_date
    FROM pershing.proceso_sfl tb_proc WHERE tb_proc.id=_id_proceso;

    DELETE FROM pershing.sfl_acct tb_sfl WHERE tb_sfl.process_date= _process_date;
--public.fn_convierte_signo_factor(
    INSERT INTO pershing.sfl_acct (id_proceso, process_date, record_id_sequence_number, account_number, ibd_number, ip_number, account_short_name, transaction_type, autotitled_usertitled_account, account_type_code, registration_type, number_of_account_title_lines, account_registration_line_1, account_registration_line_2, account_registration_line_3, account_registration_line_4, account_registration_line_5, account_registration_line_6, registration_type_detail, date_account_opened, date_account_information_updated, account_status_indicator, pending_closed_date, date_account_closed, closing_notice_date, account_reactivated_date, date_account_reopened, proceeds, transfer_instructions, income_isntructions, number_of_confirms_for_thi_account, number_of_statements_for_this_account, investment_objetive_trans_code, comments_act, employer_shotname, employers_cusip, employers_symbol, margin_privileges_revoked, statement_review_date, margin_papers_on_file, option_papers_on_file, good_faith_margin, ip_discretion_granted, invest_advisor_discretion_granted, third_party_discretion_granted, third_party_name, risk_factor_code, investment_objetive_code, option_equities, option_index, option_debt, option_currency, option_level_1, option_level_2, option_level_3, option_level_4, option_call_limits, option_put_limits, option_total_limits_of_puts_and_calls, non_us_dollar_trading, non_customer_indicator, third_party_fee_indicator, third_party_fee_approval_date, intermediary_account_ind, commission_schedule, group_index, money_manager_id, money_manager_objective_id, dtc_id_confirm_number, caps_master_mnemonic, employee_id, prime_broker_free_fund_indicator, fee_based_account_indicator, fee_based_termination_date, plan_name, self_directed_401_k_account_type, plan_type, plan_number, employee_or_employee_relative, commission_percent_discount, ind_12_b_1_fee_blocking, name_of_ip_signed_new_account_form, date_of_ip_signed_new_account_form, name_of_principal_signed_new_account_form, date_of_principal_signed_new_account_form, politically_exposed_person, private_banking_account, foreign_bank_account, initial_source_of_funds, usa_patriot_act_exempt_reason, primary_country_of_citizenship, country_of_residence, birth_date, age_based_fund_roll_exempt, money_fundreform_retail, trusted_contact_status, regulatory_account_type_category, account_managed_by_trust_comp_id, voting_auth, customer_type, fulfillment_method, credit_interest_indicator, ama_indicator, tax_id_type, tax_id_number, date_tax_id_applied_for, w_8_w_9_indicator, w_8_w_9_date_signed, w_8_w_9_effective_date, w_8_w_9_document_type, tax_status, b_notice_reason_code, first_b_notice_status, date_first_b_notice_status_issued_enforced, date_first_notice_status_satisfied, second_b_notice_status, date_second_b_notice_status_issued_enforced, date_second_b_notice_status_satisfied, c_notice_status, date_c_notice_status_issued_enforced, date_c_notice_status_satisfied, old_account_number, original_account_open_date, unidentified_large_trader_id, large_trader_type_code, large_trader_type_last_change_date, initial_source_of_funds_other, finance_away, account_funding_date, statement_currency_code, future_statement_currency_code, future_statement_currency_code_effective_date, account_level_routing_code_1, account_level_routing_code_2, account_level_routing_code_3, account_level_routing_code_4, self_directed_ind, digital_advice_ind, pte_account_ind, first_ip, second_ip, third_ip, fourth_ip, fifth_ip, sixth_ip, seventh_ip, eighth_ip, ninth_ip, tenth_ip, alert_im_acornym, alert_im_access_code, broker_acronym, cross_reference_indicator, bny_trust_indicator, source_of_asset_at_acct_opening, commission_doscount_code, external_account_number, confirmation_suppression_indicator, date_last_mail_sent, date_last_mail_sent_outside, fully_paid_lending_agreement_indicator, fully_paid_lending_agreement_date, custodian_account_type, mifid_customer_categorization, cash_management_tran_code, sweep_status_indicator, date_sweep_activated, date_sweep_details_changed, cober_margin_debit_indicator, first_fund_sweep_account_id, firstfund_sweep_account_percent, first_fundsweep_account_redemption_priority, second_fund_sweep_account_id, second_fund_sweep_account_percent, second_fundsweep_account_redemption_priority, type_of_bank_account, banklink_aba_number, banklink_dda_number, fund_bank_indicator, w_9_corp_tax_classification_code, combined_margin_acct_indicator, pledge_collateral_account_indicator, finra_institutional_account_code, proposed_account_reference_id, advisor_model_id, firm_model_style_id, dvp_restriction_code, dvp_restriction_exp_date, escheatment_withholding_ind, source_of_origination, source_of_persona, client_onboarding_method, tax_filing_code, nor_purpose_collateral_acct_ind, addr_1_trx_code, addr_1_special_handling_ind, addr_1_delivery_id, addr_1_attention_line_prefix, addr_1_attention_line_detail, addr_1_line_1, addr_1_line_2, addr_1_line_3, addr_1_line_4, addr_1_city_state, addr_1_country_code, addr_2_trx_code, addr_2_special_handling_ind, addr_2_delivery_id, addr_2_attention_line_prefix, addr_2_attention_line_detail, addr_2_line_1, addr_2_line_2, addr_2_line_3, addr_2_line_4, addr_2_city_state, addr_2_country_code, account_description, set_as_mail_addr_2_ind, principal_billing_allocation_pct, seasonal_addr_id_1, from_date_1, to_date_1, seasonal_addr_id_2, from_date_2, to_date_2, seasonal_addr_id_3, from_date_3, to_date_3, cost_basis_acct_system, disposition_method_mutual_funds, disposition_method_other, disposition_method_stocks, amortize_taxable_premium_bonds, accrue_market_disc_based_on, accrue_market_disc_income, addr_3_trx_code, addr_3_special_handling_ind, addr_3_delivery_id, addr_3_attention_line_prefix, addr_3_attention_line_detail, addr_3_line_1, addr_3_line_2, addr_3_line_3, addr_3_line_4, addr_3_city_state, addr_3_country_code, set_as_mail_addr_3_ind, addr_4_trx_code, addr_4_special_handling_ind, addr_4_delivery_id, addr_4_attention_line_prefix, addr_4_attention_line_detail, addr_4_line_1, addr_4_line_2, addr_4_line_3, addr_4_line_4, addr_4_city_state, addr_4_country_code, set_as_mail_addr_4_ind, addr_5_trx_code, addr_5_special_handling_ind, addr_5_delivery_id, addr_5_attention_line_prefix, addr_5_attention_line_detail, addr_5_line_1, addr_5_line_2, addr_5_line_3, addr_5_line_4, addr_5_city_state, addr_5_country_code, set_as_mail_addr_5_ind, addr_6_trx_code, addr_6_special_handling_ind, addr_6_delivery_id, addr_6_attention_line_prefix, addr_6_attention_line_detail, addr_6_line_1, addr_6_line_2, addr_6_line_3, addr_6_line_4, addr_6_city_state, addr_6_country_code, set_as_mail_addr_6_ind, addr_7_trx_code, addr_7_special_handling_ind, addr_7_delivery_id, addr_7_attention_line_prefix, addr_7_attention_line_detail, addr_7_line_1, addr_7_line_2, addr_7_line_3, addr_7_line_4, addr_7_city_state, addr_7_country_code, set_as_mail_addr_7_ind, record_transaction_code, base_currency, income_currency, statement_language, statement_format_code, msrb_statement_ind, pep, first_name_pep, last_name_pep, suffix_pep, political_office_held, country_of_office, foreign_bank_account_ind, foreign_bank_cert_date, foreign_bank_cert_exp_date, central_bank_ind, acct_foreign_financial_inst, foreign_bank_acct_oper_1, foreign_bank_acct_oper_2, foreign_bank_acct_oper_3, number_people_own, proprietary_acct_owned, tel_1_transaction_code, tel_1_us_ind, tel_1_type_id, tel_1_number, tel_1_extension, tel_2_transaction_code, tel_2_us_ind, tel_2_type_id, tel_2_number, tel_2_extension, tel_3_transaction_code, tel_3_us_ind, tel_3_type_id, tel_3_number, tel_3_extension, tel_4_transaction_code, tel_4_us_ind, tel_4_type_id, tel_4_number, tel_4_extension, tel_5_transaction_code, tel_5_us_ind, tel_5_type_id, tel_5_number, tel_5_extension, tel_6_transaction_code, tel_6_us_ind, tel_6_type_id, tel_6_number, tel_6_extension, tel_7_transaction_code, tel_7_us_ind, tel_7_type_id, tel_7_number, tel_7_extension, tel_8_transaction_code, tel_8_us_ind, tel_8_type_id, tel_8_number, tel_8_extension, email_address, external_position_ind, purge_eligible_ind, advisory_acct_ind, product_profile_code, cents_per_share_discount, option_disclosure_date, country_acct_level_tax_residency)
    SELECT
        reg_a.id_proceso, reg_a.process_date, reg_a.record_id_sequence_number, reg_a.account_number, reg_a.ibd_number, reg_a.ip_number,
        reg_a.account_short_name, transaction_type, autotitled_usertitled_account, account_type_code, registration_type, number_of_account_title_lines, account_registration_line_1, account_registration_line_2, account_registration_line_3, account_registration_line_4, account_registration_line_5, account_registration_line_6, registration_type_detail, date_account_opened, date_account_information_updated, account_status_indicator, pending_closed_date, date_account_closed, closing_notice_date, account_reactivated_date, date_account_reopened, proceeds, transfer_instructions, income_isntructions, number_of_confirms_for_thi_account, number_of_statements_for_this_account, investment_objetive_trans_code, comments_act, employer_shotname, employers_cusip, employers_symbol, margin_privileges_revoked, statement_review_date, margin_papers_on_file, option_papers_on_file, good_faith_margin, ip_discretion_granted, invest_advisor_discretion_granted, third_party_discretion_granted, third_party_name, risk_factor_code, investment_objetive_code, option_equities, option_index, option_debt, option_currency, option_level_1, option_level_2, option_level_3, option_level_4, option_call_limits, option_put_limits, option_total_limits_of_puts_and_calls, reg_a.non_us_dollar_trading, non_customer_indicator, third_party_fee_indicator, third_party_fee_approval_date, intermediary_account_ind, commission_schedule, group_index, money_manager_id, money_manager_objective_id, dtc_id_confirm_number, caps_master_mnemonic, employee_id, prime_broker_free_fund_indicator, fee_based_account_indicator, fee_based_termination_date, plan_name, self_directed_401_k_account_type, plan_type, plan_number, employee_or_employee_relative, commission_percent_discount, ind_12_b_1_fee_blocking, name_of_ip_signed_new_account_form, date_of_ip_signed_new_account_form, name_of_principal_signed_new_account_form, date_of_principal_signed_new_account_form, politically_exposed_person, private_banking_account, foreign_bank_account, initial_source_of_funds, usa_patriot_act_exempt_reason, primary_country_of_citizenship, country_of_residence, birth_date, age_based_fund_roll_exempt, money_fundreform_retail, trusted_contact_status, regulatory_account_type_category, account_managed_by_trust_comp_id, voting_auth, customer_type, fulfillment_method, credit_interest_indicator, ama_indicator, tax_id_type, tax_id_number, date_tax_id_applied_for, w_8_w_9_indicator, w_8_w_9_date_signed, w_8_w_9_effective_date, w_8_w_9_document_type, tax_status, b_notice_reason_code, first_b_notice_status, date_first_b_notice_status_issued_enforced, date_first_notice_status_satisfied, second_b_notice_status, date_second_b_notice_status_issued_enforced, date_second_b_notice_status_satisfied, c_notice_status, date_c_notice_status_issued_enforced, date_c_notice_status_satisfied, old_account_number, original_account_open_date, unidentified_large_trader_id, large_trader_type_code, large_trader_type_last_change_date, initial_source_of_funds_other, finance_away, account_funding_date, statement_currency_code, future_statement_currency_code, future_statement_currency_code_effective_date, account_level_routing_code_1, account_level_routing_code_2, account_level_routing_code_3, account_level_routing_code_4, self_directed_ind, digital_advice_ind, pte_account_ind, first_ip, second_ip, third_ip, fourth_ip, fifth_ip, sixth_ip, seventh_ip, eighth_ip, ninth_ip, tenth_ip, alert_im_acornym, alert_im_access_code, broker_acronym, cross_reference_indicator, bny_trust_indicator, source_of_asset_at_acct_opening, commission_doscount_code, external_account_number, confirmation_suppression_indicator, date_last_mail_sent, date_last_mail_sent_outside, fully_paid_lending_agreement_indicator, fully_paid_lending_agreement_date, custodian_account_type, mifid_customer_categorization, cash_management_tran_code, sweep_status_indicator, date_sweep_activated, date_sweep_details_changed, cober_margin_debit_indicator, first_fund_sweep_account_id, firstfund_sweep_account_percent, first_fundsweep_account_redemption_priority, second_fund_sweep_account_id, second_fund_sweep_account_percent, second_fundsweep_account_redemption_priority, type_of_bank_account, banklink_aba_number, banklink_dda_number, fund_bank_indicator, w_9_corp_tax_classification_code, combined_margin_acct_indicator, pledge_collateral_account_indicator, finra_institutional_account_code, proposed_account_reference_id, advisor_model_id, firm_model_style_id, dvp_restriction_code, dvp_restriction_exp_date, escheatment_withholding_ind, source_of_origination, source_of_persona, client_onboarding_method, tax_filing_code, nor_purpose_collateral_acct_ind, addr_1_trx_code, addr_1_special_handling_ind, addr_1_delivery_id, addr_1_attention_line_prefix, addr_1_attention_line_detail, addr_1_line_1, addr_1_line_2, addr_1_line_3, addr_1_line_4, addr_1_city_state, addr_1_country_code, addr_2_trx_code, addr_2_special_handling_ind, addr_2_delivery_id, addr_2_attention_line_prefix, addr_2_attention_line_detail, addr_2_line_1, addr_2_line_2, addr_2_line_3, addr_2_line_4, addr_2_city_state, addr_2_country_code, account_description, set_as_mail_addr_2_ind, principal_billing_allocation_pct, seasonal_addr_id_1, from_date_1, to_date_1, seasonal_addr_id_2, from_date_2, to_date_2, seasonal_addr_id_3, from_date_3, to_date_3, cost_basis_acct_system, disposition_method_mutual_funds, disposition_method_other, disposition_method_stocks, amortize_taxable_premium_bonds, accrue_market_disc_based_on, accrue_market_disc_income, addr_3_trx_code, addr_3_special_handling_ind, addr_3_delivery_id, addr_3_attention_line_prefix, addr_3_attention_line_detail, addr_3_line_1, addr_3_line_2, addr_3_line_3, addr_3_line_4, addr_3_city_state, addr_3_country_code, set_as_mail_addr_3_ind, addr_4_trx_code, addr_4_special_handling_ind, addr_4_delivery_id, addr_4_attention_line_prefix, addr_4_attention_line_detail, addr_4_line_1, addr_4_line_2, addr_4_line_3, addr_4_line_4, addr_4_city_state, addr_4_country_code, set_as_mail_addr_4_ind, addr_5_trx_code, addr_5_special_handling_ind, addr_5_delivery_id, addr_5_attention_line_prefix, addr_5_attention_line_detail, addr_5_line_1, addr_5_line_2, addr_5_line_3, addr_5_line_4, addr_5_city_state, addr_5_country_code, set_as_mail_addr_5_ind, addr_6_trx_code, addr_6_special_handling_ind, addr_6_delivery_id, addr_6_attention_line_prefix, addr_6_attention_line_detail, addr_6_line_1, addr_6_line_2, addr_6_line_3, addr_6_line_4, addr_6_city_state, addr_6_country_code, set_as_mail_addr_6_ind, addr_7_trx_code, addr_7_special_handling_ind, addr_7_delivery_id, addr_7_attention_line_prefix, addr_7_attention_line_detail, addr_7_line_1, addr_7_line_2, addr_7_line_3, addr_7_line_4, addr_7_city_state, addr_7_country_code, set_as_mail_addr_7_ind, record_transaction_code, base_currency, income_currency, statement_language, statement_format_code, msrb_statement_ind, pep, first_name_pep, last_name_pep, suffix_pep, political_office_held, country_of_office, foreign_bank_account_ind, foreign_bank_cert_date, foreign_bank_cert_exp_date, central_bank_ind, acct_foreign_financial_inst, foreign_bank_acct_oper_1, foreign_bank_acct_oper_2, foreign_bank_acct_oper_3, number_people_own, proprietary_acct_owned, tel_1_transaction_code, tel_1_us_ind, tel_1_type_id, tel_1_number, tel_1_extension, tel_2_transaction_code, tel_2_us_ind, tel_2_type_id, tel_2_number, tel_2_extension, tel_3_transaction_code, tel_3_us_ind, tel_3_type_id, tel_3_number, tel_3_extension, tel_4_transaction_code, tel_4_us_ind, tel_4_type_id, tel_4_number, tel_4_extension, tel_5_transaction_code, tel_5_us_ind, tel_5_type_id, tel_5_number, tel_5_extension, tel_6_transaction_code, tel_6_us_ind, tel_6_type_id, tel_6_number, tel_6_extension, tel_7_transaction_code, tel_7_us_ind, tel_7_type_id, tel_7_number, tel_7_extension, tel_8_transaction_code, tel_8_us_ind, tel_8_type_id, tel_8_number, tel_8_extension, email_address, external_position_ind, purge_eligible_ind, advisory_acct_ind, product_profile_code, cents_per_share_discount, option_disclosure_date, country_acct_level_tax_residency
    FROM stage_pershing.stage_acct_reg_header reg_header
    INNER JOIN stage_pershing.stage_acct_reg_trailer reg_trailer
    ON reg_header.id_proceso=reg_trailer.id_proceso
    INNER JOIN stage_pershing.stage_acct_reg_a reg_a
    ON reg_header.id_proceso=reg_a.id_proceso
    LEFT JOIN stage_pershing.stage_acct_reg_b reg_b
    ON reg_header.id_proceso=reg_b.id_proceso AND reg_a.account_number=reg_b.account_number
    LEFT JOIN stage_pershing.stage_acct_reg_c reg_c
    ON reg_header.id_proceso=reg_c.id_proceso AND reg_a.account_number=reg_c.account_number
    LEFT JOIN stage_pershing.stage_acct_reg_d reg_d
    ON reg_header.id_proceso=reg_d.id_proceso AND reg_a.account_number=reg_d.account_number
    LEFT JOIN stage_pershing.stage_acct_reg_e reg_e
    ON reg_header.id_proceso=reg_e.id_proceso AND reg_a.account_number=reg_e.account_number
    LEFT JOIN stage_pershing.stage_acct_reg_f reg_f
    ON reg_header.id_proceso=reg_f.id_proceso AND reg_a.account_number=reg_f.account_number
    LEFT JOIN stage_pershing.stage_acct_reg_w reg_w
    ON reg_header.id_proceso=reg_w.id_proceso AND reg_a.account_number=reg_w.account_number
    WHERE reg_header.id_proceso=_id_proceso
    ;

    DELETE FROM pershing.sfl_acct_historica WHERE process_date=_process_date;

    INSERT INTO pershing.sfl_acct_historica (id_proceso, process_date, record_id_sequence_number, account_number, ibd_number, ip_number, account_short_name, transaction_type, autotitled_usertitled_account, account_type_code, registration_type, number_of_account_title_lines, account_registration_line_1, account_registration_line_2, account_registration_line_3, account_registration_line_4, account_registration_line_5, account_registration_line_6, registration_type_detail, date_account_opened, date_account_information_updated, account_status_indicator, pending_closed_date, date_account_closed, closing_notice_date, account_reactivated_date, date_account_reopened, proceeds, transfer_instructions, income_isntructions, number_of_confirms_for_thi_account, number_of_statements_for_this_account, investment_objetive_trans_code, comments_act, employer_shotname, employers_cusip, employers_symbol, margin_privileges_revoked, statement_review_date, margin_papers_on_file, option_papers_on_file, good_faith_margin, ip_discretion_granted, invest_advisor_discretion_granted, third_party_discretion_granted, third_party_name, risk_factor_code, investment_objetive_code, option_equities, option_index, option_debt, option_currency, option_level_1, option_level_2, option_level_3, option_level_4, option_call_limits, option_put_limits, option_total_limits_of_puts_and_calls, non_us_dollar_trading, non_customer_indicator, third_party_fee_indicator, third_party_fee_approval_date, intermediary_account_ind, commission_schedule, group_index, money_manager_id, money_manager_objective_id, dtc_id_confirm_number, caps_master_mnemonic, employee_id, prime_broker_free_fund_indicator, fee_based_account_indicator, fee_based_termination_date, plan_name, self_directed_401_k_account_type, plan_type, plan_number, employee_or_employee_relative, commission_percent_discount, ind_12_b_1_fee_blocking, name_of_ip_signed_new_account_form, date_of_ip_signed_new_account_form, name_of_principal_signed_new_account_form, date_of_principal_signed_new_account_form, politically_exposed_person, private_banking_account, foreign_bank_account, initial_source_of_funds, usa_patriot_act_exempt_reason, primary_country_of_citizenship, country_of_residence, birth_date, age_based_fund_roll_exempt, money_fundreform_retail, trusted_contact_status, regulatory_account_type_category, account_managed_by_trust_comp_id, voting_auth, customer_type, fulfillment_method, credit_interest_indicator, ama_indicator, tax_id_type, tax_id_number, date_tax_id_applied_for, w_8_w_9_indicator, w_8_w_9_date_signed, w_8_w_9_effective_date, w_8_w_9_document_type, tax_status, b_notice_reason_code, first_b_notice_status, date_first_b_notice_status_issued_enforced, date_first_notice_status_satisfied, second_b_notice_status, date_second_b_notice_status_issued_enforced, date_second_b_notice_status_satisfied, c_notice_status, date_c_notice_status_issued_enforced, date_c_notice_status_satisfied, old_account_number, original_account_open_date, unidentified_large_trader_id, large_trader_type_code, large_trader_type_last_change_date, initial_source_of_funds_other, finance_away, account_funding_date, statement_currency_code, future_statement_currency_code, future_statement_currency_code_effective_date, account_level_routing_code_1, account_level_routing_code_2, account_level_routing_code_3, account_level_routing_code_4, self_directed_ind, digital_advice_ind, pte_account_ind, first_ip, second_ip, third_ip, fourth_ip, fifth_ip, sixth_ip, seventh_ip, eighth_ip, ninth_ip, tenth_ip, alert_im_acornym, alert_im_access_code, broker_acronym, cross_reference_indicator, bny_trust_indicator, source_of_asset_at_acct_opening, commission_doscount_code, external_account_number, confirmation_suppression_indicator, date_last_mail_sent, date_last_mail_sent_outside, fully_paid_lending_agreement_indicator, fully_paid_lending_agreement_date, custodian_account_type, mifid_customer_categorization, cash_management_tran_code, sweep_status_indicator, date_sweep_activated, date_sweep_details_changed, cober_margin_debit_indicator, first_fund_sweep_account_id, firstfund_sweep_account_percent, first_fundsweep_account_redemption_priority, second_fund_sweep_account_id, second_fund_sweep_account_percent, second_fundsweep_account_redemption_priority, type_of_bank_account, banklink_aba_number, banklink_dda_number, fund_bank_indicator, w_9_corp_tax_classification_code, combined_margin_acct_indicator, pledge_collateral_account_indicator, finra_institutional_account_code, proposed_account_reference_id, advisor_model_id, firm_model_style_id, dvp_restriction_code, dvp_restriction_exp_date, escheatment_withholding_ind, source_of_origination, source_of_persona, client_onboarding_method, tax_filing_code, nor_purpose_collateral_acct_ind, addr_1_trx_code, addr_1_special_handling_ind, addr_1_delivery_id, addr_1_attention_line_prefix, addr_1_attention_line_detail, addr_1_line_1, addr_1_line_2, addr_1_line_3, addr_1_line_4, addr_1_city_state, addr_1_country_code, addr_2_trx_code, addr_2_special_handling_ind, addr_2_delivery_id, addr_2_attention_line_prefix, addr_2_attention_line_detail, addr_2_line_1, addr_2_line_2, addr_2_line_3, addr_2_line_4, addr_2_city_state, addr_2_country_code, account_description, set_as_mail_addr_2_ind, principal_billing_allocation_pct, seasonal_addr_id_1, from_date_1, to_date_1, seasonal_addr_id_2, from_date_2, to_date_2, seasonal_addr_id_3, from_date_3, to_date_3, cost_basis_acct_system, disposition_method_mutual_funds, disposition_method_other, disposition_method_stocks, amortize_taxable_premium_bonds, accrue_market_disc_based_on, accrue_market_disc_income, addr_3_trx_code, addr_3_special_handling_ind, addr_3_delivery_id, addr_3_attention_line_prefix, addr_3_attention_line_detail, addr_3_line_1, addr_3_line_2, addr_3_line_3, addr_3_line_4, addr_3_city_state, addr_3_country_code, set_as_mail_addr_3_ind, addr_4_trx_code, addr_4_special_handling_ind, addr_4_delivery_id, addr_4_attention_line_prefix, addr_4_attention_line_detail, addr_4_line_1, addr_4_line_2, addr_4_line_3, addr_4_line_4, addr_4_city_state, addr_4_country_code, set_as_mail_addr_4_ind, addr_5_trx_code, addr_5_special_handling_ind, addr_5_delivery_id, addr_5_attention_line_prefix, addr_5_attention_line_detail, addr_5_line_1, addr_5_line_2, addr_5_line_3, addr_5_line_4, addr_5_city_state, addr_5_country_code, set_as_mail_addr_5_ind, addr_6_trx_code, addr_6_special_handling_ind, addr_6_delivery_id, addr_6_attention_line_prefix, addr_6_attention_line_detail, addr_6_line_1, addr_6_line_2, addr_6_line_3, addr_6_line_4, addr_6_city_state, addr_6_country_code, set_as_mail_addr_6_ind, addr_7_trx_code, addr_7_special_handling_ind, addr_7_delivery_id, addr_7_attention_line_prefix, addr_7_attention_line_detail, addr_7_line_1, addr_7_line_2, addr_7_line_3, addr_7_line_4, addr_7_city_state, addr_7_country_code, set_as_mail_addr_7_ind, record_transaction_code, base_currency, income_currency, statement_language, statement_format_code, msrb_statement_ind, pep, first_name_pep, last_name_pep, suffix_pep, political_office_held, country_of_office, foreign_bank_account_ind, foreign_bank_cert_date, foreign_bank_cert_exp_date, central_bank_ind, acct_foreign_financial_inst, foreign_bank_acct_oper_1, foreign_bank_acct_oper_2, foreign_bank_acct_oper_3, number_people_own, proprietary_acct_owned, tel_1_transaction_code, tel_1_us_ind, tel_1_type_id, tel_1_number, tel_1_extension, tel_2_transaction_code, tel_2_us_ind, tel_2_type_id, tel_2_number, tel_2_extension, tel_3_transaction_code, tel_3_us_ind, tel_3_type_id, tel_3_number, tel_3_extension, tel_4_transaction_code, tel_4_us_ind, tel_4_type_id, tel_4_number, tel_4_extension, tel_5_transaction_code, tel_5_us_ind, tel_5_type_id, tel_5_number, tel_5_extension, tel_6_transaction_code, tel_6_us_ind, tel_6_type_id, tel_6_number, tel_6_extension, tel_7_transaction_code, tel_7_us_ind, tel_7_type_id, tel_7_number, tel_7_extension, tel_8_transaction_code, tel_8_us_ind, tel_8_type_id, tel_8_number, tel_8_extension, email_address, external_position_ind, purge_eligible_ind, advisory_acct_ind, product_profile_code, cents_per_share_discount, option_disclosure_date, country_acct_level_tax_residency)
    SELECT
        acct_his.id_proceso, _process_date as process_date, acct_his.record_id_sequence_number, acct_his.account_number, acct_his.ibd_number, acct_his.ip_number, acct_his.account_short_name, acct_his.transaction_type, acct_his.autotitled_usertitled_account, acct_his.account_type_code, acct_his.registration_type, acct_his.number_of_account_title_lines, acct_his.account_registration_line_1, acct_his.account_registration_line_2, acct_his.account_registration_line_3, acct_his.account_registration_line_4, acct_his.account_registration_line_5, acct_his.account_registration_line_6, acct_his.registration_type_detail, acct_his.date_account_opened, acct_his.date_account_information_updated, acct_his.account_status_indicator, acct_his.pending_closed_date, acct_his.date_account_closed, acct_his.closing_notice_date, acct_his.account_reactivated_date, acct_his.date_account_reopened, acct_his.proceeds, acct_his.transfer_instructions, acct_his.income_isntructions, acct_his.number_of_confirms_for_thi_account, acct_his.number_of_statements_for_this_account, acct_his.investment_objetive_trans_code, acct_his.comments_act, acct_his.employer_shotname, acct_his.employers_cusip, acct_his.employers_symbol, acct_his.margin_privileges_revoked, acct_his.statement_review_date, acct_his.margin_papers_on_file, acct_his.option_papers_on_file, acct_his.good_faith_margin, acct_his.ip_discretion_granted, acct_his.invest_advisor_discretion_granted, acct_his.third_party_discretion_granted, acct_his.third_party_name, acct_his.risk_factor_code, acct_his.investment_objetive_code, acct_his.option_equities, acct_his.option_index, acct_his.option_debt, acct_his.option_currency, acct_his.option_level_1, acct_his.option_level_2, acct_his.option_level_3, acct_his.option_level_4, acct_his.option_call_limits, acct_his.option_put_limits, acct_his.option_total_limits_of_puts_and_calls, acct_his.non_us_dollar_trading, acct_his.non_customer_indicator, acct_his.third_party_fee_indicator, acct_his.third_party_fee_approval_date, acct_his.intermediary_account_ind, acct_his.commission_schedule, acct_his.group_index, acct_his.money_manager_id, acct_his.money_manager_objective_id, acct_his.dtc_id_confirm_number, acct_his.caps_master_mnemonic, acct_his.employee_id, acct_his.prime_broker_free_fund_indicator, acct_his.fee_based_account_indicator, acct_his.fee_based_termination_date, acct_his.plan_name, acct_his.self_directed_401_k_account_type, acct_his.plan_type, acct_his.plan_number, acct_his.employee_or_employee_relative, acct_his.commission_percent_discount, acct_his.ind_12_b_1_fee_blocking, acct_his.name_of_ip_signed_new_account_form, acct_his.date_of_ip_signed_new_account_form, acct_his.name_of_principal_signed_new_account_form, acct_his.date_of_principal_signed_new_account_form, acct_his.politically_exposed_person, acct_his.private_banking_account, acct_his.foreign_bank_account, acct_his.initial_source_of_funds, acct_his.usa_patriot_act_exempt_reason, acct_his.primary_country_of_citizenship, acct_his.country_of_residence, acct_his.birth_date, acct_his.age_based_fund_roll_exempt, acct_his.money_fundreform_retail, acct_his.trusted_contact_status, acct_his.regulatory_account_type_category, acct_his.account_managed_by_trust_comp_id, acct_his.voting_auth, acct_his.customer_type, acct_his.fulfillment_method, acct_his.credit_interest_indicator, acct_his.ama_indicator, acct_his.tax_id_type, acct_his.tax_id_number, acct_his.date_tax_id_applied_for, acct_his.w_8_w_9_indicator, acct_his.w_8_w_9_date_signed, acct_his.w_8_w_9_effective_date, acct_his.w_8_w_9_document_type, acct_his.tax_status, acct_his.b_notice_reason_code, acct_his.first_b_notice_status, acct_his.date_first_b_notice_status_issued_enforced, acct_his.date_first_notice_status_satisfied, acct_his.second_b_notice_status, acct_his.date_second_b_notice_status_issued_enforced, acct_his.date_second_b_notice_status_satisfied, acct_his.c_notice_status, acct_his.date_c_notice_status_issued_enforced, acct_his.date_c_notice_status_satisfied, acct_his.old_account_number, acct_his.original_account_open_date, acct_his.unidentified_large_trader_id, acct_his.large_trader_type_code, acct_his.large_trader_type_last_change_date, acct_his.initial_source_of_funds_other, acct_his.finance_away, acct_his.account_funding_date, acct_his.statement_currency_code, acct_his.future_statement_currency_code, acct_his.future_statement_currency_code_effective_date, acct_his.account_level_routing_code_1, acct_his.account_level_routing_code_2, acct_his.account_level_routing_code_3, acct_his.account_level_routing_code_4, acct_his.self_directed_ind, acct_his.digital_advice_ind, acct_his.pte_account_ind, acct_his.first_ip, acct_his.second_ip, acct_his.third_ip, acct_his.fourth_ip, acct_his.fifth_ip, acct_his.sixth_ip, acct_his.seventh_ip, acct_his.eighth_ip, acct_his.ninth_ip, acct_his.tenth_ip, acct_his.alert_im_acornym, acct_his.alert_im_access_code, acct_his.broker_acronym, acct_his.cross_reference_indicator, acct_his.bny_trust_indicator, acct_his.source_of_asset_at_acct_opening, acct_his.commission_doscount_code, acct_his.external_account_number, acct_his.confirmation_suppression_indicator, acct_his.date_last_mail_sent, acct_his.date_last_mail_sent_outside, acct_his.fully_paid_lending_agreement_indicator, acct_his.fully_paid_lending_agreement_date, acct_his.custodian_account_type, acct_his.mifid_customer_categorization, acct_his.cash_management_tran_code, acct_his.sweep_status_indicator, acct_his.date_sweep_activated, acct_his.date_sweep_details_changed, acct_his.cober_margin_debit_indicator, acct_his.first_fund_sweep_account_id, acct_his.firstfund_sweep_account_percent, acct_his.first_fundsweep_account_redemption_priority, acct_his.second_fund_sweep_account_id, acct_his.second_fund_sweep_account_percent, acct_his.second_fundsweep_account_redemption_priority, acct_his.type_of_bank_account, acct_his.banklink_aba_number, acct_his.banklink_dda_number, acct_his.fund_bank_indicator, acct_his.w_9_corp_tax_classification_code, acct_his.combined_margin_acct_indicator, acct_his.pledge_collateral_account_indicator, acct_his.finra_institutional_account_code, acct_his.proposed_account_reference_id, acct_his.advisor_model_id, acct_his.firm_model_style_id, acct_his.dvp_restriction_code, acct_his.dvp_restriction_exp_date, acct_his.escheatment_withholding_ind, acct_his.source_of_origination, acct_his.source_of_persona, acct_his.client_onboarding_method, acct_his.tax_filing_code, acct_his.nor_purpose_collateral_acct_ind, acct_his.addr_1_trx_code, acct_his.addr_1_special_handling_ind, acct_his.addr_1_delivery_id, acct_his.addr_1_attention_line_prefix, acct_his.addr_1_attention_line_detail, acct_his.addr_1_line_1, acct_his.addr_1_line_2, acct_his.addr_1_line_3, acct_his.addr_1_line_4, acct_his.addr_1_city_state, acct_his.addr_1_country_code, acct_his.addr_2_trx_code, acct_his.addr_2_special_handling_ind, acct_his.addr_2_delivery_id, acct_his.addr_2_attention_line_prefix, acct_his.addr_2_attention_line_detail, acct_his.addr_2_line_1, acct_his.addr_2_line_2, acct_his.addr_2_line_3, acct_his.addr_2_line_4, acct_his.addr_2_city_state, acct_his.addr_2_country_code, acct_his.account_description, acct_his.set_as_mail_addr_2_ind, acct_his.principal_billing_allocation_pct, acct_his.seasonal_addr_id_1, acct_his.from_date_1, acct_his.to_date_1, acct_his.seasonal_addr_id_2, acct_his.from_date_2, acct_his.to_date_2, acct_his.seasonal_addr_id_3, acct_his.from_date_3, acct_his.to_date_3, acct_his.cost_basis_acct_system, acct_his.disposition_method_mutual_funds, acct_his.disposition_method_other, acct_his.disposition_method_stocks, acct_his.amortize_taxable_premium_bonds, acct_his.accrue_market_disc_based_on, acct_his.accrue_market_disc_income, acct_his.addr_3_trx_code, acct_his.addr_3_special_handling_ind, acct_his.addr_3_delivery_id, acct_his.addr_3_attention_line_prefix, acct_his.addr_3_attention_line_detail, acct_his.addr_3_line_1, acct_his.addr_3_line_2, acct_his.addr_3_line_3, acct_his.addr_3_line_4, acct_his.addr_3_city_state, acct_his.addr_3_country_code, acct_his.set_as_mail_addr_3_ind, acct_his.addr_4_trx_code, acct_his.addr_4_special_handling_ind, acct_his.addr_4_delivery_id, acct_his.addr_4_attention_line_prefix, acct_his.addr_4_attention_line_detail, acct_his.addr_4_line_1, acct_his.addr_4_line_2, acct_his.addr_4_line_3, acct_his.addr_4_line_4, acct_his.addr_4_city_state, acct_his.addr_4_country_code, acct_his.set_as_mail_addr_4_ind, acct_his.addr_5_trx_code, acct_his.addr_5_special_handling_ind, acct_his.addr_5_delivery_id, acct_his.addr_5_attention_line_prefix, acct_his.addr_5_attention_line_detail, acct_his.addr_5_line_1, acct_his.addr_5_line_2, acct_his.addr_5_line_3, acct_his.addr_5_line_4, acct_his.addr_5_city_state, acct_his.addr_5_country_code, acct_his.set_as_mail_addr_5_ind, acct_his.addr_6_trx_code, acct_his.addr_6_special_handling_ind, acct_his.addr_6_delivery_id, acct_his.addr_6_attention_line_prefix, acct_his.addr_6_attention_line_detail, acct_his.addr_6_line_1, acct_his.addr_6_line_2, acct_his.addr_6_line_3, acct_his.addr_6_line_4, acct_his.addr_6_city_state, acct_his.addr_6_country_code, acct_his.set_as_mail_addr_6_ind, acct_his.addr_7_trx_code, acct_his.addr_7_special_handling_ind, acct_his.addr_7_delivery_id, acct_his.addr_7_attention_line_prefix, acct_his.addr_7_attention_line_detail, acct_his.addr_7_line_1, acct_his.addr_7_line_2, acct_his.addr_7_line_3, acct_his.addr_7_line_4, acct_his.addr_7_city_state, acct_his.addr_7_country_code, acct_his.set_as_mail_addr_7_ind, acct_his.record_transaction_code, acct_his.base_currency, acct_his.income_currency, acct_his.statement_language, acct_his.statement_format_code, acct_his.msrb_statement_ind, acct_his.pep, acct_his.first_name_pep, acct_his.last_name_pep, acct_his.suffix_pep, acct_his.political_office_held, acct_his.country_of_office, acct_his.foreign_bank_account_ind, acct_his.foreign_bank_cert_date, acct_his.foreign_bank_cert_exp_date, acct_his.central_bank_ind, acct_his.acct_foreign_financial_inst, acct_his.foreign_bank_acct_oper_1, acct_his.foreign_bank_acct_oper_2, acct_his.foreign_bank_acct_oper_3, acct_his.number_people_own, acct_his.proprietary_acct_owned, acct_his.tel_1_transaction_code, acct_his.tel_1_us_ind, acct_his.tel_1_type_id, acct_his.tel_1_number, acct_his.tel_1_extension, acct_his.tel_2_transaction_code, acct_his.tel_2_us_ind, acct_his.tel_2_type_id, acct_his.tel_2_number, acct_his.tel_2_extension, acct_his.tel_3_transaction_code, acct_his.tel_3_us_ind, acct_his.tel_3_type_id, acct_his.tel_3_number, acct_his.tel_3_extension, acct_his.tel_4_transaction_code, acct_his.tel_4_us_ind, acct_his.tel_4_type_id, acct_his.tel_4_number, acct_his.tel_4_extension, acct_his.tel_5_transaction_code, acct_his.tel_5_us_ind, acct_his.tel_5_type_id, acct_his.tel_5_number, acct_his.tel_5_extension, acct_his.tel_6_transaction_code, acct_his.tel_6_us_ind, acct_his.tel_6_type_id, acct_his.tel_6_number, acct_his.tel_6_extension, acct_his.tel_7_transaction_code, acct_his.tel_7_us_ind, acct_his.tel_7_type_id, acct_his.tel_7_number, acct_his.tel_7_extension, acct_his.tel_8_transaction_code, acct_his.tel_8_us_ind, acct_his.tel_8_type_id, acct_his.tel_8_number, acct_his.tel_8_extension, acct_his.email_address, acct_his.external_position_ind, acct_his.purge_eligible_ind, acct_his.advisory_acct_ind, acct_his.product_profile_code, acct_his.cents_per_share_discount, acct_his.option_disclosure_date, acct_his.country_acct_level_tax_residency
    FROM pershing.sfl_acct acct_his
    INNER JOIN
    (
        SELECT max(acct_det.process_date) as process_date, acct_det.account_number
        FROM pershing.sfl_acct acct_det
        WHERE acct_det.process_date<=_process_date
        GROUP BY acct_det.account_number
    ) as acct_last
    ON acct_his.process_date=acct_last.process_date
    AND acct_his.account_number=acct_last.account_number
    ;
end;
$$;

alter procedure pershing.pa_procesa_acct(bigint) owner to postgres;

