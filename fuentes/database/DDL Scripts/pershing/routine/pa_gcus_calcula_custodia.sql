create or replace procedure pershing.pa_gcus_calcula_custodia(IN _process_date character varying)
    language plpgsql
as
$$
DECLARE _cursor_reg_modif refcursor;
DECLARE _reg_modif record;
begin

    IF (_process_date IS NULL) THEN
        RAISE EXCEPTION 'Process Date no puede ser NULL';
    END IF;

    TRUNCATE TABLE pershing.sfl_gcus_actual;

    INSERT INTO pershing.sfl_gcus_actual (id_proceso, process_date, record_id_sequence_number, account_number, cusip_number, portfolio_currency, underlying_cusip_number, country_code, ip_record_number, ibd_number, currency_security_indicator, issue_currency, datestamp_trade_date, datestamp_settlement_date, trade_date_quantity, settlement_date_quantity, seg_quantity, safekeeping_quantity, transfer_quantity, pending_transfer_quantity, legal_transfer_quantity, tendered_quantity, pending_papers, short_against_the_box_quantity, networked_quantity, pending_split_quantity, quantity_covering_options, trade_date_quantity_bought, trade_date_quantity_sold, fed_rquirement, house_margin_requirement, nyse_requirement, equity_requirment, security_symbol, security_type, security_mod, security_calc, minor_product_code, network_eligibility_indicator, strike_price, expiration_maturity_date, contract_size, conversion_ratio, account_short_name, state_code, country_code_account, number_security_description_lines, security_description_line_1, security_description_line_2, security_description_line_3, security_description_line_4, security_description_line_5, security_description_line_6, dividend_option, long_term_capital_gains_option, short_term_capital_gains_option, firm_trading_indicator, position_currency_security, trade_date_liquidating_value, pool_factor, exchange_rate, settlement_date_liquidating_value, alternate_security_id_type, alternate_security_id, position_currency, fully_paid_lending_quantity, fully_paid_lending_quantity_collateral_amount, option_root_id, expiration_date, call_put_indicator, trade_date_repo_quantity, settlement_date_repo_quantity, trade_date_reverse_repo_quantity, settlement_date_reverse_repo_quantity, collateral_pledge_quantity, corporate_exec_serv_collateral_pledge_quantity, trade_date_repo_liquidating_value, settlement_date_repo_liquidating_value, trade_date_reverse_repo_liquidating_value, settlement_date_reverse_repo_liquidating_value, collateral_pledge_liquidating_value, corporate_exec_serv_collateral_pledge_liquidating_value, trade_date_repo_loan_amount, settlement_date_repo_loan_amount, trade_date_reverse_repo_loan_amount, settlement_date_reverse_repo_loan_amount, accrued_interes_value, dividend_or_coupon_rate, pending_split_quantity_liquidating_value, internal_non_dollar_symbol, pledged_quantity)
    SELECT tb_det.id_proceso, tb_det.process_date, tb_det.record_id_sequence_number, tb_det.account_number, tb_det.cusip_number, tb_det.portfolio_currency, tb_det.underlying_cusip_number, tb_det.country_code, tb_det.ip_record_number, tb_det.ibd_number, tb_det.currency_security_indicator, tb_det.issue_currency, tb_det.datestamp_trade_date, tb_det.datestamp_settlement_date, tb_det.trade_date_quantity, tb_det.settlement_date_quantity, tb_det.seg_quantity, tb_det.safekeeping_quantity, tb_det.transfer_quantity, tb_det.pending_transfer_quantity, tb_det.legal_transfer_quantity, tb_det.tendered_quantity, tb_det.pending_papers, tb_det.short_against_the_box_quantity, tb_det.networked_quantity, tb_det.pending_split_quantity, tb_det.quantity_covering_options, tb_det.trade_date_quantity_bought, tb_det.trade_date_quantity_sold, tb_det.fed_rquirement, tb_det.house_margin_requirement, tb_det.nyse_requirement, tb_det.equity_requirment, tb_det.security_symbol, tb_det.security_type, tb_det.security_mod, tb_det.security_calc, tb_det.minor_product_code, tb_det.network_eligibility_indicator, tb_det.strike_price, tb_det.expiration_maturity_date, tb_det.contract_size, tb_det.conversion_ratio, tb_det.account_short_name, tb_det.state_code, tb_det.country_code_account, tb_det.number_security_description_lines, tb_det.security_description_line_1, tb_det.security_description_line_2, tb_det.security_description_line_3, tb_det.security_description_line_4, tb_det.security_description_line_5, tb_det.security_description_line_6, tb_det.dividend_option, tb_det.long_term_capital_gains_option, tb_det.short_term_capital_gains_option, tb_det.firm_trading_indicator, tb_det.position_currency_security, tb_det.trade_date_liquidating_value, tb_det.pool_factor, tb_det.exchange_rate, tb_det.settlement_date_liquidating_value, tb_det.alternate_security_id_type, tb_det.alternate_security_id, tb_det.position_currency, tb_det.fully_paid_lending_quantity, tb_det.fully_paid_lending_quantity_collateral_amount, tb_det.option_root_id, tb_det.expiration_date, tb_det.call_put_indicator, tb_det.trade_date_repo_quantity, tb_det.settlement_date_repo_quantity, tb_det.trade_date_reverse_repo_quantity, tb_det.settlement_date_reverse_repo_quantity, tb_det.collateral_pledge_quantity, tb_det.corporate_exec_serv_collateral_pledge_quantity, tb_det.trade_date_repo_liquidating_value, tb_det.settlement_date_repo_liquidating_value, tb_det.trade_date_reverse_repo_liquidating_value, tb_det.settlement_date_reverse_repo_liquidating_value, tb_det.collateral_pledge_liquidating_value, tb_det.corporate_exec_serv_collateral_pledge_liquidating_value, tb_det.trade_date_repo_loan_amount, tb_det.settlement_date_repo_loan_amount, tb_det.trade_date_reverse_repo_loan_amount, tb_det.settlement_date_reverse_repo_loan_amount, tb_det.accrued_interes_value, tb_det.dividend_or_coupon_rate, tb_det.pending_split_quantity_liquidating_value, tb_det.internal_non_dollar_symbol, tb_det.pledged_quantity
    FROM pershing.sfl_gcus tb_det
    INNER JOIN
    (
        SELECT max(gcus_acum.process_date) as process_date, gcus_acum.account_number, gcus_acum.cusip_number, gcus_acum.currency_security_indicator
        FROM pershing.sfl_gcus gcus_acum
        WHERE gcus_acum.process_date<=_process_date
        GROUP BY gcus_acum.account_number, gcus_acum.cusip_number, gcus_acum.currency_security_indicator
    ) as tb_cab
    ON tb_det.process_date=tb_cab.process_date
    AND tb_det.account_number=tb_cab.account_number
    AND tb_det.cusip_number=tb_cab.cusip_number
    AND tb_det.currency_security_indicator=tb_cab.currency_security_indicator
    AND tb_det.process_date=tb_cab.process_date
    ;

    DELETE FROM pershing.sfl_gcus_historica gcus_del WHERE gcus_del.process_date=_process_date;

    INSERT INTO pershing.sfl_gcus_historica (id_proceso, process_date, record_id_sequence_number, account_number, cusip_number, portfolio_currency, underlying_cusip_number, country_code, ip_record_number, ibd_number, currency_security_indicator, issue_currency, datestamp_trade_date, datestamp_settlement_date, trade_date_quantity, settlement_date_quantity, seg_quantity, safekeeping_quantity, transfer_quantity, pending_transfer_quantity, legal_transfer_quantity, tendered_quantity, pending_papers, short_against_the_box_quantity, networked_quantity, pending_split_quantity, quantity_covering_options, trade_date_quantity_bought, trade_date_quantity_sold, fed_rquirement, house_margin_requirement, nyse_requirement, equity_requirment, security_symbol, security_type, security_mod, security_calc, minor_product_code, network_eligibility_indicator, strike_price, expiration_maturity_date, contract_size, conversion_ratio, account_short_name, state_code, country_code_account, number_security_description_lines, security_description_line_1, security_description_line_2, security_description_line_3, security_description_line_4, security_description_line_5, security_description_line_6, dividend_option, long_term_capital_gains_option, short_term_capital_gains_option, firm_trading_indicator, position_currency_security, trade_date_liquidating_value, pool_factor, exchange_rate, settlement_date_liquidating_value, alternate_security_id_type, alternate_security_id, position_currency, fully_paid_lending_quantity, fully_paid_lending_quantity_collateral_amount, option_root_id, expiration_date, call_put_indicator, trade_date_repo_quantity, settlement_date_repo_quantity, trade_date_reverse_repo_quantity, settlement_date_reverse_repo_quantity, collateral_pledge_quantity, corporate_exec_serv_collateral_pledge_quantity, trade_date_repo_liquidating_value, settlement_date_repo_liquidating_value, trade_date_reverse_repo_liquidating_value, settlement_date_reverse_repo_liquidating_value, collateral_pledge_liquidating_value, corporate_exec_serv_collateral_pledge_liquidating_value, trade_date_repo_loan_amount, settlement_date_repo_loan_amount, trade_date_reverse_repo_loan_amount, settlement_date_reverse_repo_loan_amount, accrued_interes_value, dividend_or_coupon_rate, pending_split_quantity_liquidating_value, internal_non_dollar_symbol, pledged_quantity)
    SELECT
        gcus_act.id_proceso, _process_date as process_date, gcus_act.record_id_sequence_number, gcus_act.account_number, gcus_act.cusip_number, gcus_act.portfolio_currency, gcus_act.underlying_cusip_number, gcus_act.country_code, gcus_act.ip_record_number, gcus_act.ibd_number, gcus_act.currency_security_indicator, gcus_act.issue_currency, gcus_act.datestamp_trade_date, gcus_act.datestamp_settlement_date, gcus_act.trade_date_quantity, gcus_act.settlement_date_quantity, gcus_act.seg_quantity, gcus_act.safekeeping_quantity, gcus_act.transfer_quantity, gcus_act.pending_transfer_quantity, gcus_act.legal_transfer_quantity, gcus_act.tendered_quantity, gcus_act.pending_papers, gcus_act.short_against_the_box_quantity, gcus_act.networked_quantity, gcus_act.pending_split_quantity, gcus_act.quantity_covering_options, gcus_act.trade_date_quantity_bought, gcus_act.trade_date_quantity_sold, gcus_act.fed_rquirement, gcus_act.house_margin_requirement, gcus_act.nyse_requirement, gcus_act.equity_requirment, gcus_act.security_symbol, gcus_act.security_type, gcus_act.security_mod, gcus_act.security_calc, gcus_act.minor_product_code, gcus_act.network_eligibility_indicator, gcus_act.strike_price, gcus_act.expiration_maturity_date, gcus_act.contract_size, gcus_act.conversion_ratio, gcus_act.account_short_name, gcus_act.state_code, gcus_act.country_code_account, gcus_act.number_security_description_lines, gcus_act.security_description_line_1, gcus_act.security_description_line_2, gcus_act.security_description_line_3, gcus_act.security_description_line_4, gcus_act.security_description_line_5, gcus_act.security_description_line_6, gcus_act.dividend_option, gcus_act.long_term_capital_gains_option, gcus_act.short_term_capital_gains_option, gcus_act.firm_trading_indicator, gcus_act.position_currency_security, gcus_act.trade_date_liquidating_value, gcus_act.pool_factor, gcus_act.exchange_rate, gcus_act.settlement_date_liquidating_value, gcus_act.alternate_security_id_type, gcus_act.alternate_security_id, gcus_act.position_currency, gcus_act.fully_paid_lending_quantity, gcus_act.fully_paid_lending_quantity_collateral_amount, gcus_act.option_root_id, gcus_act.expiration_date, gcus_act.call_put_indicator, gcus_act.trade_date_repo_quantity, gcus_act.settlement_date_repo_quantity, gcus_act.trade_date_reverse_repo_quantity, gcus_act.settlement_date_reverse_repo_quantity, gcus_act.collateral_pledge_quantity, gcus_act.corporate_exec_serv_collateral_pledge_quantity, gcus_act.trade_date_repo_liquidating_value, gcus_act.settlement_date_repo_liquidating_value, gcus_act.trade_date_reverse_repo_liquidating_value, gcus_act.settlement_date_reverse_repo_liquidating_value, gcus_act.collateral_pledge_liquidating_value, gcus_act.corporate_exec_serv_collateral_pledge_liquidating_value, gcus_act.trade_date_repo_loan_amount, gcus_act.settlement_date_repo_loan_amount, gcus_act.trade_date_reverse_repo_loan_amount, gcus_act.settlement_date_reverse_repo_loan_amount, gcus_act.accrued_interes_value, gcus_act.dividend_or_coupon_rate, gcus_act.pending_split_quantity_liquidating_value, gcus_act.internal_non_dollar_symbol, gcus_act.pledged_quantity
    FROM pershing.sfl_gcus_actual gcus_act;

end;
$$;

alter procedure pershing.pa_gcus_calcula_custodia(varchar) owner to postgres;

