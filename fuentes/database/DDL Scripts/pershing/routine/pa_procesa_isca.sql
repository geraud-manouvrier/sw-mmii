create or replace procedure pershing.pa_procesa_isca(IN _id_proceso bigint)
    language plpgsql
as
$$
DECLARE _process_date VARCHAR(100);
DECLARE _last_process_date VARCHAR(100);
begin

    SELECT tb_proc.process_date INTO _process_date
    FROM pershing.proceso_sfl tb_proc WHERE tb_proc.id=_id_proceso;

    DELETE FROM pershing.sfl_isca tb_sfl WHERE tb_sfl.process_date= _process_date;

    INSERT INTO pershing.sfl_isca (id_proceso, process_date, cusip_number, security_type, security_modifier, security_calculation_code, primary_exchange, coupon_rate_fis_or_indicated_dividend_eq, maturity_option_expire_date, underlying_security_cusip, first_call_price_fix_inc_or_strike_price_option, first_par_call_price_fix_inc_or_units_option, primary_symbol, interest_frequency, bond_class, first_coupon_day, call_indicator, put_indicator, next_par_call_date, prerefunded_date, next_premium_call_date, dated_date_for_fix_inc_or_ex_dividend_date_eq, first_coupon_fix_inc_or_payable_date_eq, federal_marginable_ind, cns_eligible_code, dtcc_eligible_code, nscc_eligible_code, foreign_security, second_coupon_day, dividend_interest_payment_method, minor_product_code, etf_indicator, bid_price, ask_price, previous_day_price, latest_price, end_of_month_price, round_lot_quantity, dividend_reinvestment_eligibility_indicator, previous_price_date, latest_price_date, end_of_month_price_date, record_date, fundvest_ind, country_code, standard_poor_rating, moodys_rating, bond_sub_class, restriction_indicator, trace_indicator, new_interest_calculation_code, sic_code, state_tax_ind, fts_ind, amt_ind, ric_indicator, number_of_description_lines, secutiry_description_line_1, secutiry_description_line_2, secutiry_description_line_3, secutiry_description_line_4, secutiry_description_line_5, user_cusip_identifier, price_purge_date, taxable_indicator, secutiry_description_line_6, put_price, put_date, second_premium_call_price, second_premium_call_date, called_date, pool_number, factor, factor_date, previous_factor, previous_factor_date, variable_rate_indicator, next_last_coupon_date, structured_product_ind, perpetual_bond_indicator, exp_first_call_price, exp_first_par_call_price, exp_put_price, exp_second_premium_call_price, name_issuer_security, issuing_currency, globally_locked_sec_ind, globally_locked_reason_code, spac_ind, eor, expanded_bid_price, expanded_ask_price, expanded_previous_day_price, expanded_latest_price, expanded_end_of_month_price, contract_share_quantity, year_covered_under_cost_basis_rules, delta, delta_value_presence_ind, isin_code, issuer_identifier, symbol_of_the_underlying_security, asset_type, asset_subtype, asset_subsubtype, payment_day_delays, exchange_rate_denom_currency_usd, underlying_cusip_1, deliverable_unit_quantity_1, underlying_cusip_2, deliverable_unit_quantity_2, underlying_cusip_3, deliverable_unit_quantity_3, underlying_cusip_4, deliverable_unit_quantity_4, annual_dividend_currency_code, outstanding_shares, option_root_id, expiration_date, call_put_indicator, strike_price, fund_type, broad_narrow_indicator, leverage_factor, outstanding_shares_update_date, expanded_symbol, state_of_issuance, option_excercise_pricing_model_code, first_accrual_date, tranche_code, worthless_security_indicator, uit_termination_code, fdic_certification_number, revenue_stream, restricted_marijuana_ind, factored_market_value_multiplier, current_yield, yield, price_source, country_of_origin, retricted_security_code, international_non_dollar_symbol, international_exchange, variable_rate_category_code, interest_rate_completion_ind, exchange_code_sedol_1, sedol_1, exchange_code_sedol_2, sedol_2, exchange_code_sedol_3, sedol_3, exchange_code_sedol_4, sedol_4, exchange_code_sedol_5, sedol_5, exchange_code_sedol_6, sedol_6, exchange_code_sedol_7, sedol_7, exchange_code_sedol_8, sedol_8, exchange_code_sedol_9, sedol_9, exchange_code_sedol_10, sedol_10, exchange_code_sedol_11, sedol_11, primary_idc_mkt_exch, primary_mkt_exch_trading_status, primary_mkt_symbol, primary_mkt_exch_effective_date, primary_mkt_status_code, secondary_idc_mkt_exch, secondary_mkt_exch_trading_status, secondary_mkt_symbol, secondary_mkt_exch_effective_date, secondary_mkt_status_code, tick_size_pilot_group, tick_size_effective_date, tick_size_change_date, update_date, oas_libor_rate, first_call_date, first_call_price, second_call_date, second_call_price, third_call_date, third_call_price, fourth_call_date, fourth_call_price, effective_date_rate_1, coupon_interest_rate_1, effective_date_rate_2, coupon_interest_rate_2, effective_date_rate_3, coupon_interest_rate_3, effective_date_rate_4, coupon_interest_rate_4, oas_treasury_rate, oas_treasury_effective_date, minimum_piece, minimum_increment, issue_date_security)
    SELECT
        reg_header.id_proceso, reg_header.process_date, reg_a.cusip_number, security_type, security_modifier, security_calculation_code, primary_exchange, coupon_rate_fis_or_indicated_dividend_eq, maturity_option_expire_date, underlying_security_cusip, first_call_price_fix_inc_or_strike_price_option, first_par_call_price_fix_inc_or_units_option, primary_symbol, interest_frequency, bond_class, first_coupon_day, call_indicator, put_indicator, next_par_call_date, prerefunded_date, next_premium_call_date, dated_date_for_fix_inc_or_ex_dividend_date_eq, first_coupon_fix_inc_or_payable_date_eq, federal_marginable_ind, cns_eligible_code, dtcc_eligible_code, nscc_eligible_code, foreign_security, second_coupon_day, dividend_interest_payment_method, minor_product_code, etf_indicator, bid_price, ask_price, previous_day_price, reg_b.latest_price, end_of_month_price, round_lot_quantity, dividend_reinvestment_eligibility_indicator, previous_price_date, reg_b.latest_price_date, end_of_month_price_date, record_date, fundvest_ind, country_code, standard_poor_rating, moodys_rating, bond_sub_class, restriction_indicator, trace_indicator, new_interest_calculation_code, sic_code, state_tax_ind, fts_ind, amt_ind, ric_indicator, number_of_description_lines, secutiry_description_line_1, secutiry_description_line_2, secutiry_description_line_3, secutiry_description_line_4, secutiry_description_line_5, user_cusip_identifier, price_purge_date, taxable_indicator, secutiry_description_line_6, put_price, put_date, second_premium_call_price, second_premium_call_date, called_date, pool_number, factor, factor_date, previous_factor, previous_factor_date, variable_rate_indicator, next_last_coupon_date, structured_product_ind, perpetual_bond_indicator, exp_first_call_price, exp_first_par_call_price, exp_put_price, exp_second_premium_call_price, name_issuer_security, issuing_currency, globally_locked_sec_ind, globally_locked_reason_code, spac_ind, reg_a.eor, expanded_bid_price, expanded_ask_price, expanded_previous_day_price, expanded_latest_price, expanded_end_of_month_price, contract_share_quantity, year_covered_under_cost_basis_rules,
        delta*public.fn_convierte_signo_factor(reg_g.delta_sign), delta_value_presence_ind, isin_code, issuer_identifier, symbol_of_the_underlying_security, asset_type, asset_subtype, asset_subsubtype, payment_day_delays, exchange_rate_denom_currency_usd, underlying_cusip_1, deliverable_unit_quantity_1, underlying_cusip_2, deliverable_unit_quantity_2, underlying_cusip_3, deliverable_unit_quantity_3, underlying_cusip_4, deliverable_unit_quantity_4, annual_dividend_currency_code, outstanding_shares, option_root_id, expiration_date, call_put_indicator, strike_price, fund_type, broad_narrow_indicator,
        leverage_factor*public.fn_convierte_signo_factor(reg_i.leverage_factor_sign), outstanding_shares_update_date, expanded_symbol, state_of_issuance, option_excercise_pricing_model_code, first_accrual_date, tranche_code, worthless_security_indicator, uit_termination_code, fdic_certification_number, revenue_stream, restricted_marijuana_ind, factored_market_value_multiplier, current_yield, yield, price_source, country_of_origin, retricted_security_code, international_non_dollar_symbol, international_exchange, variable_rate_category_code, interest_rate_completion_ind, exchange_code_sedol_1, sedol_1, exchange_code_sedol_2, sedol_2, exchange_code_sedol_3, sedol_3, exchange_code_sedol_4, sedol_4, exchange_code_sedol_5, sedol_5, exchange_code_sedol_6, sedol_6, exchange_code_sedol_7, sedol_7, exchange_code_sedol_8, sedol_8, exchange_code_sedol_9, sedol_9, exchange_code_sedol_10, sedol_10, exchange_code_sedol_11, sedol_11, primary_idc_mkt_exch, primary_mkt_exch_trading_status, primary_mkt_symbol, primary_mkt_exch_effective_date, primary_mkt_status_code, secondary_idc_mkt_exch, secondary_mkt_exch_trading_status, secondary_mkt_symbol, secondary_mkt_exch_effective_date, secondary_mkt_status_code, tick_size_pilot_group, tick_size_effective_date, tick_size_change_date, update_date,
        oas_libor_rate*public.fn_convierte_signo_factor(reg_l.oas_libor_rate_sign), first_call_date, first_call_price, second_call_date, second_call_price, third_call_date, third_call_price, fourth_call_date, fourth_call_price, effective_date_rate_1, coupon_interest_rate_1, effective_date_rate_2, coupon_interest_rate_2, effective_date_rate_3, coupon_interest_rate_3, effective_date_rate_4, coupon_interest_rate_4,
        oas_treasury_rate*public.fn_convierte_signo_factor(reg_o.oas_treasury_rate_sign), oas_treasury_effective_date, minimum_piece, minimum_increment, issue_date_security
    FROM stage_pershing.stage_isca_reg_header reg_header
    INNER JOIN stage_pershing.stage_isca_reg_trailer reg_trailer
    ON reg_header.id_proceso=reg_trailer.id_proceso
    INNER JOIN stage_pershing.stage_isca_reg_a reg_a
    ON reg_header.id_proceso=reg_a.id_proceso
    LEFT JOIN stage_pershing.stage_isca_reg_b reg_b
    ON reg_header.id_proceso=reg_b.id_proceso AND reg_a.cusip_number=reg_b.cusip_number
    LEFT JOIN stage_pershing.stage_isca_reg_c reg_c
    ON reg_header.id_proceso=reg_c.id_proceso AND reg_a.cusip_number=reg_c.cusip_number
    LEFT JOIN stage_pershing.stage_isca_reg_d reg_d
    ON reg_header.id_proceso=reg_d.id_proceso AND reg_a.cusip_number=reg_d.cusip_number
    LEFT JOIN stage_pershing.stage_isca_reg_e reg_e
    ON reg_header.id_proceso=reg_e.id_proceso AND reg_a.cusip_number=reg_e.cusip_number
    LEFT JOIN stage_pershing.stage_isca_reg_f reg_f
    ON reg_header.id_proceso=reg_f.id_proceso AND reg_a.cusip_number=reg_f.cusip_number
    LEFT JOIN stage_pershing.stage_isca_reg_g reg_g
    ON reg_header.id_proceso=reg_g.id_proceso AND reg_a.cusip_number=reg_g.cusip_number
    LEFT JOIN stage_pershing.stage_isca_reg_h reg_h
    ON reg_header.id_proceso=reg_h.id_proceso AND reg_a.cusip_number=reg_h.cusip_number
    LEFT JOIN stage_pershing.stage_isca_reg_i reg_i
    ON reg_header.id_proceso=reg_i.id_proceso AND reg_a.cusip_number=reg_i.cusip_number
    LEFT JOIN stage_pershing.stage_isca_reg_j reg_j
    ON reg_header.id_proceso=reg_j.id_proceso AND reg_a.cusip_number=reg_j.cusip_number
    LEFT JOIN stage_pershing.stage_isca_reg_k reg_k
    ON reg_header.id_proceso=reg_k.id_proceso AND reg_a.cusip_number=reg_k.cusip_number
    LEFT JOIN stage_pershing.stage_isca_reg_l reg_l
    ON reg_header.id_proceso=reg_l.id_proceso AND reg_a.cusip_number=reg_l.cusip_number
    LEFT JOIN stage_pershing.stage_isca_reg_m reg_m
    ON reg_header.id_proceso=reg_m.id_proceso AND reg_a.cusip_number=reg_m.cusip_number
    LEFT JOIN stage_pershing.stage_isca_reg_n reg_n
    ON reg_header.id_proceso=reg_n.id_proceso AND reg_a.cusip_number=reg_n.cusip_number
    LEFT JOIN stage_pershing.stage_isca_reg_o reg_o
    ON reg_header.id_proceso=reg_o.id_proceso AND reg_a.cusip_number=reg_o.cusip_number
    WHERE reg_header.id_proceso=_id_proceso
    ;


    DELETE FROM pershing.sfl_isca_historica WHERE process_date=_process_date;

    --Si no se cargaron datos y no existe SFL
    IF ( (SELECT count(*) FROM pershing.sfl_isca where process_date=_process_date)=0
        AND
         (SELECT count(*) FROM stage_pershing.stage_isca_reg_header where process_date=_process_date)=0 ) THEN
        --Replicar data ultimo process date disponible
        SELECT max(process_date) INTO _last_process_date
        FROM pershing.sfl_isca where process_date<=_process_date;

        INSERT INTO pershing.sfl_isca_historica (id_proceso, process_date, cusip_number, security_type, security_modifier, security_calculation_code, primary_exchange, coupon_rate_fis_or_indicated_dividend_eq, maturity_option_expire_date, underlying_security_cusip, first_call_price_fix_inc_or_strike_price_option, first_par_call_price_fix_inc_or_units_option, primary_symbol, interest_frequency, bond_class, first_coupon_day, call_indicator, put_indicator, next_par_call_date, prerefunded_date, next_premium_call_date, dated_date_for_fix_inc_or_ex_dividend_date_eq, first_coupon_fix_inc_or_payable_date_eq, federal_marginable_ind, cns_eligible_code, dtcc_eligible_code, nscc_eligible_code, foreign_security, second_coupon_day, dividend_interest_payment_method, minor_product_code, etf_indicator, bid_price, ask_price, previous_day_price, latest_price, end_of_month_price, round_lot_quantity, dividend_reinvestment_eligibility_indicator, previous_price_date, latest_price_date, end_of_month_price_date, record_date, fundvest_ind, country_code, standard_poor_rating, moodys_rating, bond_sub_class, restriction_indicator, trace_indicator, new_interest_calculation_code, sic_code, state_tax_ind, fts_ind, amt_ind, ric_indicator, number_of_description_lines, secutiry_description_line_1, secutiry_description_line_2, secutiry_description_line_3, secutiry_description_line_4, secutiry_description_line_5, user_cusip_identifier, price_purge_date, taxable_indicator, secutiry_description_line_6, put_price, put_date, second_premium_call_price, second_premium_call_date, called_date, pool_number, factor, factor_date, previous_factor, previous_factor_date, variable_rate_indicator, next_last_coupon_date, structured_product_ind, perpetual_bond_indicator, exp_first_call_price, exp_first_par_call_price, exp_put_price, exp_second_premium_call_price, name_issuer_security, issuing_currency, globally_locked_sec_ind, globally_locked_reason_code, spac_ind, eor, expanded_bid_price, expanded_ask_price, expanded_previous_day_price, expanded_latest_price, expanded_end_of_month_price, contract_share_quantity, year_covered_under_cost_basis_rules, delta, delta_value_presence_ind, isin_code, issuer_identifier, symbol_of_the_underlying_security, asset_type, asset_subtype, asset_subsubtype, payment_day_delays, exchange_rate_denom_currency_usd, underlying_cusip_1, deliverable_unit_quantity_1, underlying_cusip_2, deliverable_unit_quantity_2, underlying_cusip_3, deliverable_unit_quantity_3, underlying_cusip_4, deliverable_unit_quantity_4, annual_dividend_currency_code, outstanding_shares, option_root_id, expiration_date, call_put_indicator, strike_price, fund_type, broad_narrow_indicator, leverage_factor, outstanding_shares_update_date, expanded_symbol, state_of_issuance, option_excercise_pricing_model_code, first_accrual_date, tranche_code, worthless_security_indicator, uit_termination_code, fdic_certification_number, revenue_stream, restricted_marijuana_ind, factored_market_value_multiplier, current_yield, yield, price_source, country_of_origin, retricted_security_code, international_non_dollar_symbol, international_exchange, variable_rate_category_code, interest_rate_completion_ind, exchange_code_sedol_1, sedol_1, exchange_code_sedol_2, sedol_2, exchange_code_sedol_3, sedol_3, exchange_code_sedol_4, sedol_4, exchange_code_sedol_5, sedol_5, exchange_code_sedol_6, sedol_6, exchange_code_sedol_7, sedol_7, exchange_code_sedol_8, sedol_8, exchange_code_sedol_9, sedol_9, exchange_code_sedol_10, sedol_10, exchange_code_sedol_11, sedol_11, primary_idc_mkt_exch, primary_mkt_exch_trading_status, primary_mkt_symbol, primary_mkt_exch_effective_date, primary_mkt_status_code, secondary_idc_mkt_exch, secondary_mkt_exch_trading_status, secondary_mkt_symbol, secondary_mkt_exch_effective_date, secondary_mkt_status_code, tick_size_pilot_group, tick_size_effective_date, tick_size_change_date, update_date, oas_libor_rate, first_call_date, first_call_price, second_call_date, second_call_price, third_call_date, third_call_price, fourth_call_date, fourth_call_price, effective_date_rate_1, coupon_interest_rate_1, effective_date_rate_2, coupon_interest_rate_2, effective_date_rate_3, coupon_interest_rate_3, effective_date_rate_4, coupon_interest_rate_4, oas_treasury_rate, oas_treasury_effective_date, minimum_piece, minimum_increment, issue_date_security)
        SELECT
            isca_his.id_proceso, _process_date as process_date, isca_his.cusip_number, isca_his.security_type, isca_his.security_modifier, isca_his.security_calculation_code, isca_his.primary_exchange, isca_his.coupon_rate_fis_or_indicated_dividend_eq, isca_his.maturity_option_expire_date, isca_his.underlying_security_cusip, isca_his.first_call_price_fix_inc_or_strike_price_option, isca_his.first_par_call_price_fix_inc_or_units_option, isca_his.primary_symbol, isca_his.interest_frequency, isca_his.bond_class, isca_his.first_coupon_day, isca_his.call_indicator, isca_his.put_indicator, isca_his.next_par_call_date, isca_his.prerefunded_date, isca_his.next_premium_call_date, isca_his.dated_date_for_fix_inc_or_ex_dividend_date_eq, isca_his.first_coupon_fix_inc_or_payable_date_eq, isca_his.federal_marginable_ind, isca_his.cns_eligible_code, isca_his.dtcc_eligible_code, isca_his.nscc_eligible_code, isca_his.foreign_security, isca_his.second_coupon_day, isca_his.dividend_interest_payment_method, isca_his.minor_product_code, isca_his.etf_indicator, isca_his.bid_price, isca_his.ask_price, isca_his.previous_day_price, isca_his.latest_price, isca_his.end_of_month_price, isca_his.round_lot_quantity, isca_his.dividend_reinvestment_eligibility_indicator, isca_his.previous_price_date, isca_his.latest_price_date, isca_his.end_of_month_price_date, isca_his.record_date, isca_his.fundvest_ind, isca_his.country_code, isca_his.standard_poor_rating, isca_his.moodys_rating, isca_his.bond_sub_class, isca_his.restriction_indicator, isca_his.trace_indicator, isca_his.new_interest_calculation_code, isca_his.sic_code, isca_his.state_tax_ind, isca_his.fts_ind, isca_his.amt_ind, isca_his.ric_indicator, isca_his.number_of_description_lines, isca_his.secutiry_description_line_1, isca_his.secutiry_description_line_2, isca_his.secutiry_description_line_3, isca_his.secutiry_description_line_4, isca_his.secutiry_description_line_5, isca_his.user_cusip_identifier, isca_his.price_purge_date, isca_his.taxable_indicator, isca_his.secutiry_description_line_6, isca_his.put_price, isca_his.put_date, isca_his.second_premium_call_price, isca_his.second_premium_call_date, isca_his.called_date, isca_his.pool_number, isca_his.factor, isca_his.factor_date, isca_his.previous_factor, isca_his.previous_factor_date, isca_his.variable_rate_indicator, isca_his.next_last_coupon_date, isca_his.structured_product_ind, isca_his.perpetual_bond_indicator, isca_his.exp_first_call_price, isca_his.exp_first_par_call_price, isca_his.exp_put_price, isca_his.exp_second_premium_call_price, isca_his.name_issuer_security, isca_his.issuing_currency, isca_his.globally_locked_sec_ind, isca_his.globally_locked_reason_code, isca_his.spac_ind, isca_his.eor, isca_his.expanded_bid_price, isca_his.expanded_ask_price, isca_his.expanded_previous_day_price, isca_his.expanded_latest_price, isca_his.expanded_end_of_month_price, isca_his.contract_share_quantity, isca_his.year_covered_under_cost_basis_rules, isca_his.delta, isca_his.delta_value_presence_ind, isca_his.isin_code, isca_his.issuer_identifier, isca_his.symbol_of_the_underlying_security, isca_his.asset_type, isca_his.asset_subtype, isca_his.asset_subsubtype, isca_his.payment_day_delays, isca_his.exchange_rate_denom_currency_usd, isca_his.underlying_cusip_1, isca_his.deliverable_unit_quantity_1, isca_his.underlying_cusip_2, isca_his.deliverable_unit_quantity_2, isca_his.underlying_cusip_3, isca_his.deliverable_unit_quantity_3, isca_his.underlying_cusip_4, isca_his.deliverable_unit_quantity_4, isca_his.annual_dividend_currency_code, isca_his.outstanding_shares, isca_his.option_root_id, isca_his.expiration_date, isca_his.call_put_indicator, isca_his.strike_price, isca_his.fund_type, isca_his.broad_narrow_indicator, isca_his.leverage_factor, isca_his.outstanding_shares_update_date, isca_his.expanded_symbol, isca_his.state_of_issuance, isca_his.option_excercise_pricing_model_code, isca_his.first_accrual_date, isca_his.tranche_code, isca_his.worthless_security_indicator, isca_his.uit_termination_code, isca_his.fdic_certification_number, isca_his.revenue_stream, isca_his.restricted_marijuana_ind, isca_his.factored_market_value_multiplier, isca_his.current_yield, isca_his.yield, isca_his.price_source, isca_his.country_of_origin, isca_his.retricted_security_code, isca_his.international_non_dollar_symbol, isca_his.international_exchange, isca_his.variable_rate_category_code, isca_his.interest_rate_completion_ind, isca_his.exchange_code_sedol_1, isca_his.sedol_1, isca_his.exchange_code_sedol_2, isca_his.sedol_2, isca_his.exchange_code_sedol_3, isca_his.sedol_3, isca_his.exchange_code_sedol_4, isca_his.sedol_4, isca_his.exchange_code_sedol_5, isca_his.sedol_5, isca_his.exchange_code_sedol_6, isca_his.sedol_6, isca_his.exchange_code_sedol_7, isca_his.sedol_7, isca_his.exchange_code_sedol_8, isca_his.sedol_8, isca_his.exchange_code_sedol_9, isca_his.sedol_9, isca_his.exchange_code_sedol_10, isca_his.sedol_10, isca_his.exchange_code_sedol_11, isca_his.sedol_11, isca_his.primary_idc_mkt_exch, isca_his.primary_mkt_exch_trading_status, isca_his.primary_mkt_symbol, isca_his.primary_mkt_exch_effective_date, isca_his.primary_mkt_status_code, isca_his.secondary_idc_mkt_exch, isca_his.secondary_mkt_exch_trading_status, isca_his.secondary_mkt_symbol, isca_his.secondary_mkt_exch_effective_date, isca_his.secondary_mkt_status_code, isca_his.tick_size_pilot_group, isca_his.tick_size_effective_date, isca_his.tick_size_change_date, isca_his.update_date, isca_his.oas_libor_rate, isca_his.first_call_date, isca_his.first_call_price, isca_his.second_call_date, isca_his.second_call_price, isca_his.third_call_date, isca_his.third_call_price, isca_his.fourth_call_date, isca_his.fourth_call_price, isca_his.effective_date_rate_1, isca_his.coupon_interest_rate_1, isca_his.effective_date_rate_2, isca_his.coupon_interest_rate_2, isca_his.effective_date_rate_3, isca_his.coupon_interest_rate_3, isca_his.effective_date_rate_4, isca_his.coupon_interest_rate_4, isca_his.oas_treasury_rate, isca_his.oas_treasury_effective_date, isca_his.minimum_piece, isca_his.minimum_increment, isca_his.issue_date_security
        FROM pershing.sfl_isca isca_his
        WHERE isca_his.process_date=_last_process_date;

    ELSE

        INSERT INTO pershing.sfl_isca_historica (id_proceso, process_date, cusip_number, security_type, security_modifier, security_calculation_code, primary_exchange, coupon_rate_fis_or_indicated_dividend_eq, maturity_option_expire_date, underlying_security_cusip, first_call_price_fix_inc_or_strike_price_option, first_par_call_price_fix_inc_or_units_option, primary_symbol, interest_frequency, bond_class, first_coupon_day, call_indicator, put_indicator, next_par_call_date, prerefunded_date, next_premium_call_date, dated_date_for_fix_inc_or_ex_dividend_date_eq, first_coupon_fix_inc_or_payable_date_eq, federal_marginable_ind, cns_eligible_code, dtcc_eligible_code, nscc_eligible_code, foreign_security, second_coupon_day, dividend_interest_payment_method, minor_product_code, etf_indicator, bid_price, ask_price, previous_day_price, latest_price, end_of_month_price, round_lot_quantity, dividend_reinvestment_eligibility_indicator, previous_price_date, latest_price_date, end_of_month_price_date, record_date, fundvest_ind, country_code, standard_poor_rating, moodys_rating, bond_sub_class, restriction_indicator, trace_indicator, new_interest_calculation_code, sic_code, state_tax_ind, fts_ind, amt_ind, ric_indicator, number_of_description_lines, secutiry_description_line_1, secutiry_description_line_2, secutiry_description_line_3, secutiry_description_line_4, secutiry_description_line_5, user_cusip_identifier, price_purge_date, taxable_indicator, secutiry_description_line_6, put_price, put_date, second_premium_call_price, second_premium_call_date, called_date, pool_number, factor, factor_date, previous_factor, previous_factor_date, variable_rate_indicator, next_last_coupon_date, structured_product_ind, perpetual_bond_indicator, exp_first_call_price, exp_first_par_call_price, exp_put_price, exp_second_premium_call_price, name_issuer_security, issuing_currency, globally_locked_sec_ind, globally_locked_reason_code, spac_ind, eor, expanded_bid_price, expanded_ask_price, expanded_previous_day_price, expanded_latest_price, expanded_end_of_month_price, contract_share_quantity, year_covered_under_cost_basis_rules, delta, delta_value_presence_ind, isin_code, issuer_identifier, symbol_of_the_underlying_security, asset_type, asset_subtype, asset_subsubtype, payment_day_delays, exchange_rate_denom_currency_usd, underlying_cusip_1, deliverable_unit_quantity_1, underlying_cusip_2, deliverable_unit_quantity_2, underlying_cusip_3, deliverable_unit_quantity_3, underlying_cusip_4, deliverable_unit_quantity_4, annual_dividend_currency_code, outstanding_shares, option_root_id, expiration_date, call_put_indicator, strike_price, fund_type, broad_narrow_indicator, leverage_factor, outstanding_shares_update_date, expanded_symbol, state_of_issuance, option_excercise_pricing_model_code, first_accrual_date, tranche_code, worthless_security_indicator, uit_termination_code, fdic_certification_number, revenue_stream, restricted_marijuana_ind, factored_market_value_multiplier, current_yield, yield, price_source, country_of_origin, retricted_security_code, international_non_dollar_symbol, international_exchange, variable_rate_category_code, interest_rate_completion_ind, exchange_code_sedol_1, sedol_1, exchange_code_sedol_2, sedol_2, exchange_code_sedol_3, sedol_3, exchange_code_sedol_4, sedol_4, exchange_code_sedol_5, sedol_5, exchange_code_sedol_6, sedol_6, exchange_code_sedol_7, sedol_7, exchange_code_sedol_8, sedol_8, exchange_code_sedol_9, sedol_9, exchange_code_sedol_10, sedol_10, exchange_code_sedol_11, sedol_11, primary_idc_mkt_exch, primary_mkt_exch_trading_status, primary_mkt_symbol, primary_mkt_exch_effective_date, primary_mkt_status_code, secondary_idc_mkt_exch, secondary_mkt_exch_trading_status, secondary_mkt_symbol, secondary_mkt_exch_effective_date, secondary_mkt_status_code, tick_size_pilot_group, tick_size_effective_date, tick_size_change_date, update_date, oas_libor_rate, first_call_date, first_call_price, second_call_date, second_call_price, third_call_date, third_call_price, fourth_call_date, fourth_call_price, effective_date_rate_1, coupon_interest_rate_1, effective_date_rate_2, coupon_interest_rate_2, effective_date_rate_3, coupon_interest_rate_3, effective_date_rate_4, coupon_interest_rate_4, oas_treasury_rate, oas_treasury_effective_date, minimum_piece, minimum_increment, issue_date_security)
        SELECT
            isca_his.id_proceso, _process_date as process_date, isca_his.cusip_number, isca_his.security_type, isca_his.security_modifier, isca_his.security_calculation_code, isca_his.primary_exchange, isca_his.coupon_rate_fis_or_indicated_dividend_eq, isca_his.maturity_option_expire_date, isca_his.underlying_security_cusip, isca_his.first_call_price_fix_inc_or_strike_price_option, isca_his.first_par_call_price_fix_inc_or_units_option, isca_his.primary_symbol, isca_his.interest_frequency, isca_his.bond_class, isca_his.first_coupon_day, isca_his.call_indicator, isca_his.put_indicator, isca_his.next_par_call_date, isca_his.prerefunded_date, isca_his.next_premium_call_date, isca_his.dated_date_for_fix_inc_or_ex_dividend_date_eq, isca_his.first_coupon_fix_inc_or_payable_date_eq, isca_his.federal_marginable_ind, isca_his.cns_eligible_code, isca_his.dtcc_eligible_code, isca_his.nscc_eligible_code, isca_his.foreign_security, isca_his.second_coupon_day, isca_his.dividend_interest_payment_method, isca_his.minor_product_code, isca_his.etf_indicator, isca_his.bid_price, isca_his.ask_price, isca_his.previous_day_price, isca_his.latest_price, isca_his.end_of_month_price, isca_his.round_lot_quantity, isca_his.dividend_reinvestment_eligibility_indicator, isca_his.previous_price_date, isca_his.latest_price_date, isca_his.end_of_month_price_date, isca_his.record_date, isca_his.fundvest_ind, isca_his.country_code, isca_his.standard_poor_rating, isca_his.moodys_rating, isca_his.bond_sub_class, isca_his.restriction_indicator, isca_his.trace_indicator, isca_his.new_interest_calculation_code, isca_his.sic_code, isca_his.state_tax_ind, isca_his.fts_ind, isca_his.amt_ind, isca_his.ric_indicator, isca_his.number_of_description_lines, isca_his.secutiry_description_line_1, isca_his.secutiry_description_line_2, isca_his.secutiry_description_line_3, isca_his.secutiry_description_line_4, isca_his.secutiry_description_line_5, isca_his.user_cusip_identifier, isca_his.price_purge_date, isca_his.taxable_indicator, isca_his.secutiry_description_line_6, isca_his.put_price, isca_his.put_date, isca_his.second_premium_call_price, isca_his.second_premium_call_date, isca_his.called_date, isca_his.pool_number, isca_his.factor, isca_his.factor_date, isca_his.previous_factor, isca_his.previous_factor_date, isca_his.variable_rate_indicator, isca_his.next_last_coupon_date, isca_his.structured_product_ind, isca_his.perpetual_bond_indicator, isca_his.exp_first_call_price, isca_his.exp_first_par_call_price, isca_his.exp_put_price, isca_his.exp_second_premium_call_price, isca_his.name_issuer_security, isca_his.issuing_currency, isca_his.globally_locked_sec_ind, isca_his.globally_locked_reason_code, isca_his.spac_ind, isca_his.eor, isca_his.expanded_bid_price, isca_his.expanded_ask_price, isca_his.expanded_previous_day_price, isca_his.expanded_latest_price, isca_his.expanded_end_of_month_price, isca_his.contract_share_quantity, isca_his.year_covered_under_cost_basis_rules, isca_his.delta, isca_his.delta_value_presence_ind, isca_his.isin_code, isca_his.issuer_identifier, isca_his.symbol_of_the_underlying_security, isca_his.asset_type, isca_his.asset_subtype, isca_his.asset_subsubtype, isca_his.payment_day_delays, isca_his.exchange_rate_denom_currency_usd, isca_his.underlying_cusip_1, isca_his.deliverable_unit_quantity_1, isca_his.underlying_cusip_2, isca_his.deliverable_unit_quantity_2, isca_his.underlying_cusip_3, isca_his.deliverable_unit_quantity_3, isca_his.underlying_cusip_4, isca_his.deliverable_unit_quantity_4, isca_his.annual_dividend_currency_code, isca_his.outstanding_shares, isca_his.option_root_id, isca_his.expiration_date, isca_his.call_put_indicator, isca_his.strike_price, isca_his.fund_type, isca_his.broad_narrow_indicator, isca_his.leverage_factor, isca_his.outstanding_shares_update_date, isca_his.expanded_symbol, isca_his.state_of_issuance, isca_his.option_excercise_pricing_model_code, isca_his.first_accrual_date, isca_his.tranche_code, isca_his.worthless_security_indicator, isca_his.uit_termination_code, isca_his.fdic_certification_number, isca_his.revenue_stream, isca_his.restricted_marijuana_ind, isca_his.factored_market_value_multiplier, isca_his.current_yield, isca_his.yield, isca_his.price_source, isca_his.country_of_origin, isca_his.retricted_security_code, isca_his.international_non_dollar_symbol, isca_his.international_exchange, isca_his.variable_rate_category_code, isca_his.interest_rate_completion_ind, isca_his.exchange_code_sedol_1, isca_his.sedol_1, isca_his.exchange_code_sedol_2, isca_his.sedol_2, isca_his.exchange_code_sedol_3, isca_his.sedol_3, isca_his.exchange_code_sedol_4, isca_his.sedol_4, isca_his.exchange_code_sedol_5, isca_his.sedol_5, isca_his.exchange_code_sedol_6, isca_his.sedol_6, isca_his.exchange_code_sedol_7, isca_his.sedol_7, isca_his.exchange_code_sedol_8, isca_his.sedol_8, isca_his.exchange_code_sedol_9, isca_his.sedol_9, isca_his.exchange_code_sedol_10, isca_his.sedol_10, isca_his.exchange_code_sedol_11, isca_his.sedol_11, isca_his.primary_idc_mkt_exch, isca_his.primary_mkt_exch_trading_status, isca_his.primary_mkt_symbol, isca_his.primary_mkt_exch_effective_date, isca_his.primary_mkt_status_code, isca_his.secondary_idc_mkt_exch, isca_his.secondary_mkt_exch_trading_status, isca_his.secondary_mkt_symbol, isca_his.secondary_mkt_exch_effective_date, isca_his.secondary_mkt_status_code, isca_his.tick_size_pilot_group, isca_his.tick_size_effective_date, isca_his.tick_size_change_date, isca_his.update_date, isca_his.oas_libor_rate, isca_his.first_call_date, isca_his.first_call_price, isca_his.second_call_date, isca_his.second_call_price, isca_his.third_call_date, isca_his.third_call_price, isca_his.fourth_call_date, isca_his.fourth_call_price, isca_his.effective_date_rate_1, isca_his.coupon_interest_rate_1, isca_his.effective_date_rate_2, isca_his.coupon_interest_rate_2, isca_his.effective_date_rate_3, isca_his.coupon_interest_rate_3, isca_his.effective_date_rate_4, isca_his.coupon_interest_rate_4, isca_his.oas_treasury_rate, isca_his.oas_treasury_effective_date, isca_his.minimum_piece, isca_his.minimum_increment, isca_his.issue_date_security
        FROM pershing.sfl_isca isca_his
        WHERE isca_his.process_date=_process_date
        ;
    END IF;

end;
$$;

alter procedure pershing.pa_procesa_isca(bigint) owner to postgres;

