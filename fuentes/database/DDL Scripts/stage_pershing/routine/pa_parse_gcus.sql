create or replace procedure stage_pershing.pa_parse_gcus(IN _id_proceso bigint)
    language plpgsql
as
$$
DECLARE _cursor_reg_modif refcursor;
DECLARE _reg_modif record;
DECLARE _process_date VARCHAR(100);
begin

    DELETE FROM stage_pershing.stage_gcus_reg_header reg_del WHERE reg_del.id_proceso=_id_proceso;
    DELETE FROM stage_pershing.stage_gcus_reg_a reg_del WHERE reg_del.id_proceso=_id_proceso;
    DELETE FROM stage_pershing.stage_gcus_reg_b reg_del WHERE reg_del.id_proceso=_id_proceso;
    DELETE FROM stage_pershing.stage_gcus_reg_trailer reg_del WHERE reg_del.id_proceso=_id_proceso;

    INSERT INTO stage_pershing.stage_gcus_reg_header (id_proceso, process_date, bof, campo_2, campo_3, date_of_data, campo_5, remote_id, campo_7, run_date, campo_9, run_time, campo_11, refreshed_or_updated, campo_13, eof)
    SELECT id_proceso, process_date, bof, campo_2, campo_3, date_of_data, campo_5, remote_id, campo_7, run_date, campo_9, run_time, campo_11, refreshed_or_updated, campo_13, eof
    FROM stage_pershing.fn_parse_gcus_reg_header(_id_proceso);

    INSERT INTO stage_pershing.stage_gcus_reg_a (id_proceso, process_date, transaction_code, record_indicator_value, record_id_sequence_number, account_number, cusip_number, portfolio_currency, campo_7, underlying_cusip_number, country_code, campo_10, ip_record_number, ibd_number, currency_security_indicator, issue_currency, datestamp_trade_date, datestamp_settlement_date, trade_date_quantity, trade_date_quantity_sign, settlement_date_quantity, settlement_date_quantity_sign, seg_quantity, seg_quantity_sign, safekeeping_quantity, safekeeping_sign, transfer_quantity, transfer_quantity_sign, pending_transfer_quantity, pending_transfer_quantity_sign, legal_transfer_quantity, legal_transfer_quantity_sign, tendered_quantity, tendered_quantity_sign, pending_papers, pending_papers_sign, short_against_the_box_quantity, short_against_the_box_quantity_sign, networked_quantity, networked_quantity_sign, pending_split_quantity, pending_split_quantity_sign, quantity_covering_options, quantity_covering_options_sign, trade_date_quantity_bought, trade_date_quantity_bought_sign, trade_date_quantity_sold, trade_date_quantity_sold_sign, fed_rquirement, fed_rquirement_sign, house_margin_requirement, house_margin_requirement_sign, nyse_requirement, nyse_requirement_sign, equity_requirment, equity_requirment_sign, security_symbol, security_type, security_mod, security_calc, minor_product_code, network_eligibility_indicator, strike_price, strike_price_sign, expiration_maturity_date, contract_size, conversion_ratio, account_short_name, state_code, country_code_account, campo_69, number_security_description_lines, security_description_line_1, security_description_line_2, security_description_line_3, security_description_line_4, security_description_line_5, security_description_line_6, dividend_option, long_term_capital_gains_option, short_term_capital_gains_option, firm_trading_indicator, position_currency_security, trade_date_liquidating_value, trade_date_liquidating_value_sign, pool_factor, pool_factor_sign, exchange_rate, exchange_rate_sign, settlement_date_liquidating_value, settlement_date_liquidating_value_sign, campo_90, alternate_security_id_type, alternate_security_id, campo_93, eor)
    SELECT id_proceso, process_date, transaction_code, record_indicator_value, record_id_sequence_number, account_number, cusip_number, portfolio_currency, campo_7, underlying_cusip_number, country_code, campo_10, ip_record_number, ibd_number, currency_security_indicator, issue_currency, datestamp_trade_date, datestamp_settlement_date, trade_date_quantity, trade_date_quantity_sign, settlement_date_quantity, settlement_date_quantity_sign, seg_quantity, seg_quantity_sign, safekeeping_quantity, safekeeping_sign, transfer_quantity, transfer_quantity_sign, pending_transfer_quantity, pending_transfer_quantity_sign, legal_transfer_quantity, legal_transfer_quantity_sign, tendered_quantity, tendered_quantity_sign, pending_papers, pending_papers_sign, short_against_the_box_quantity, short_against_the_box_quantity_sign, networked_quantity, networked_quantity_sign, pending_split_quantity, pending_split_quantity_sign, quantity_covering_options, quantity_covering_options_sign, trade_date_quantity_bought, trade_date_quantity_bought_sign, trade_date_quantity_sold, trade_date_quantity_sold_sign, fed_rquirement, fed_rquirement_sign, house_margin_requirement, house_margin_requirement_sign, nyse_requirement, nyse_requirement_sign, equity_requirment, equity_requirment_sign, security_symbol, security_type, security_mod, security_calc, minor_product_code, network_eligibility_indicator, strike_price, strike_price_sign, expiration_maturity_date, contract_size, conversion_ratio, account_short_name, state_code, country_code_account, campo_69, number_security_description_lines, security_description_line_1, security_description_line_2, security_description_line_3, security_description_line_4, security_description_line_5, security_description_line_6, dividend_option, long_term_capital_gains_option, short_term_capital_gains_option, firm_trading_indicator, position_currency_security, trade_date_liquidating_value, trade_date_liquidating_value_sign, pool_factor, pool_factor_sign, exchange_rate, exchange_rate_sign, settlement_date_liquidating_value, settlement_date_liquidating_value_sign, campo_90, alternate_security_id_type, alternate_security_id, campo_93, eor
    FROM stage_pershing.fn_parse_gcus_reg_a(_id_proceso);

    INSERT INTO stage_pershing.stage_gcus_reg_b (id_proceso, process_date, transaction_code, record_indicator_value, recor_id_sequence_number, account_number, cusip_number, position_currency, campo_7, underlying_cusip_number, country_code, campo_10, ip_record_number, ibd_number, fully_paid_lending_quantity, fully_paid_lending_quantity_sign, fully_paid_lending_quantity_collateral_amount, fully_paid_lending_quantity_collateral_amount_sign, option_root_id, expiration_date, call_put_indicator, strike_price, trade_date_repo_quantity, trade_date_repo_quantity_sign, settlement_date_repo_quantity, settlement_date_repo_quantity_sign, trade_date_reverse_repo_quantity, trade_date_reverse_repo_quantity_sign, settlement_date_reverse_repo_quantity, settlement_date_reverse_repo_quantity_sign, collateral_pledge_quantity, collateral_pledge_quantity_sign, corporate_exec_serv_collateral_pledge_quantity, corporate_exec_serv_collateral_pledge_quantity_sign, trade_date_repo_liquidating_value, trade_date_repo_liquidating_value_sign, settlement_date_repo_liquidating_value, settlement_date_repo_liquidating_value_sign, trade_date_reverse_repo_liquidating_value, trade_date_reverse_repo_liquidating_value_sign, settlement_date_reverse_repo_liquidating_value, settlement_date_reverse_repo_liquidating_value_sign, collateral_pledge_liquidating_value, collateral_pledge_liquidating_value_sign, corporate_exec_serv_collateral_pledge_liquidating_value, corporate_exec_serv_collateral_pledge_liquidating_value_sign, trade_date_repo_loan_amount, trade_date_repo_loan_amount_sign, settlement_date_repo_loan_amount, settlement_date_repo_loan_amount_sign, trade_date_reverse_repo_loan_amount, trade_date_reverse_repo_loan_amount_sign, settlement_date_reverse_repo_loan_amount, settlement_date_reverse_repo_loan_amount_sign, accrued_interes_value, accrued_interes_value_sign, dividend_or_coupon_rate, pending_split_quantity_liquidating_value, pending_split_quantity_liquidating_value_sign, campo_58, internal_non_dollar_symbol, pledged_quantity, pledged_quantity_sign, campo_62, eor)
    SELECT id_proceso, process_date, transaction_code, record_indicator_value, recor_id_sequence_number, account_number, cusip_number, position_currency, campo_7, underlying_cusip_number, country_code, campo_10, ip_record_number, ibd_number, fully_paid_lending_quantity, fully_paid_lending_quantity_sign, fully_paid_lending_quantity_collateral_amount, fully_paid_lending_quantity_collateral_amount_sign, option_root_id, expiration_date, call_put_indicator, strike_price, trade_date_repo_quantity, trade_date_repo_quantity_sign, settlement_date_repo_quantity, settlement_date_repo_quantity_sign, trade_date_reverse_repo_quantity, trade_date_reverse_repo_quantity_sign, settlement_date_reverse_repo_quantity, settlement_date_reverse_repo_quantity_sign, collateral_pledge_quantity, collateral_pledge_quantity_sign, corporate_exec_serv_collateral_pledge_quantity, corporate_exec_serv_collateral_pledge_quantity_sign, trade_date_repo_liquidating_value, trade_date_repo_liquidating_value_sign, settlement_date_repo_liquidating_value, settlement_date_repo_liquidating_value_sign, trade_date_reverse_repo_liquidating_value, trade_date_reverse_repo_liquidating_value_sign, settlement_date_reverse_repo_liquidating_value, settlement_date_reverse_repo_liquidating_value_sign, collateral_pledge_liquidating_value, collateral_pledge_liquidating_value_sign, corporate_exec_serv_collateral_pledge_liquidating_value, corporate_exec_serv_collateral_pledge_liquidating_value_sign, trade_date_repo_loan_amount, trade_date_repo_loan_amount_sign, settlement_date_repo_loan_amount, settlement_date_repo_loan_amount_sign, trade_date_reverse_repo_loan_amount, trade_date_reverse_repo_loan_amount_sign, settlement_date_reverse_repo_loan_amount, settlement_date_reverse_repo_loan_amount_sign, accrued_interes_value, accrued_interes_value_sign, dividend_or_coupon_rate, pending_split_quantity_liquidating_value, pending_split_quantity_liquidating_value_sign, campo_58, internal_non_dollar_symbol, pledged_quantity, pledged_quantity_sign, campo_62, eor
    FROM stage_pershing.fn_parse_gcus_reg_b(_id_proceso);

    INSERT INTO stage_pershing.stage_gcus_reg_trailer (id_proceso, process_date, eof, campo_2, campo_3, date_of_data, campo_5, remote_id, campo_7, number_detail_of_records, campo_9, refreshed_or_updated, campo_11, eor)
    SELECT id_proceso, process_date, eof, campo_2, campo_3, date_of_data, campo_5, remote_id, campo_7, number_detail_of_records, campo_9, refreshed_or_updated, campo_11, eor
    FROM stage_pershing.fn_parse_gcus_reg_trailer(_id_proceso);

end;
$$;

alter procedure stage_pershing.pa_parse_gcus(bigint) owner to postgres;

